name: Build YKS Timer APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Gradle 8.2
        run: |
          curl -L https://services.gradle.org/distributions/gradle-8.2-bin.zip -o gradle.zip
          unzip -q gradle.zip
          echo "$PWD/gradle-8.2/bin" >> $GITHUB_PATH

      - name: Generate Android Project (FULL)
        run: |
          set -e

          # -----------------------------
          # DIZINLER
          # -----------------------------
          mkdir -p app/src/main/java/com/yks/timer
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/raw
          mkdir -p app/src/main/res/mipmap-mdpi
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-xhdpi
          mkdir -p app/src/main/res/mipmap-xxhdpi

          # -----------------------------
          # SETTINGS
          # -----------------------------
          cat > settings.gradle <<'EOF'
          rootProject.name = "YKSTimer"
          include(":app")
          EOF

          # -----------------------------
          # ROOT BUILD
          # -----------------------------
          cat > build.gradle <<'EOF'
          plugins {
              id "com.android.application" version "8.2.2" apply false
          }
          EOF

          # -----------------------------
          # GRADLE PROPS
          # -----------------------------
          cat > gradle.properties <<'EOF'
          org.gradle.jvmargs=-Xmx2048m
          android.useAndroidX=true
          android.enableJetifier=false
          EOF

          # -----------------------------
          # APP BUILD
          # -----------------------------
          cat > app/build.gradle <<'EOF'
          plugins { id "com.android.application" }

          android {
              namespace "com.yks.timer"
              compileSdk 34

              defaultConfig {
                  applicationId "com.yks.timer"
                  minSdk 23
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  debug { debuggable true }
                  release {
                      minifyEnabled false
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
          }

          dependencies {}
          EOF

          # -----------------------------
          # MANIFEST (NO INTERNET)
          # -----------------------------
          cat > app/src/main/AndroidManifest.xml <<'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">

              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>

              <application
                  android:label="YKS Sayaç"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher"
                  android:theme="@android:style/Theme.DeviceDefault.NoActionBar">

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>

                  <service
                      android:name=".TimerService"
                      android:exported="false"
                      android:foregroundServiceType="dataSync"/>
              </application>

          </manifest>
          EOF

          # -----------------------------
          # STRINGS
          # -----------------------------
          cat > app/src/main/res/values/strings.xml <<'EOF'
          <resources>
              <string name="app_name">YKS Sayaç</string>
              <string name="start_pause">Başlat / Duraklat</string>
              <string name="reset">Sıfırla</string>
              <string name="next">Soruyu Geç</string>
              <string name="close">Kapat</string>
              <string name="time_up">SÜRE DOLDU</string>
          </resources>
          EOF

          # -----------------------------
          # MAIN LAYOUT
          # -----------------------------
          cat > app/src/main/res/layout/activity_main.xml <<'EOF'
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:orientation="vertical"
              android:padding="24dp">

              <EditText
                  android:id="@+id/min"
                  android:hint="Dakika"
                  android:inputType="number"
                  android:text="1"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"/>

              <EditText
                  android:id="@+id/sec"
                  android:hint="Saniye"
                  android:inputType="number"
                  android:text="0"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"/>

              <SeekBar
                  android:id="@+id/sizeSeek"
                  android:max="99"
                  android:progress="39"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"/>

              <Button
                  android:id="@+id/start"
                  android:text="Başlat"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"/>

          </LinearLayout>
          EOF

          # -----------------------------
          # MAIN ACTIVITY
          # -----------------------------
          cat > app/src/main/java/com/yks/timer/MainActivity.java <<'EOF'
          package com.yks.timer;

          import android.app.Activity;
          import android.content.Intent;
          import android.net.Uri;
          import android.os.Build;
          import android.os.Bundle;
          import android.provider.Settings;
          import android.widget.*;

          public class MainActivity extends Activity {

              protected void onCreate(Bundle b) {
                  super.onCreate(b);
                  setContentView(R.layout.activity_main);

                  EditText min = findViewById(R.id.min);
                  EditText sec = findViewById(R.id.sec);
                  SeekBar size = findViewById(R.id.sizeSeek);

                  findViewById(R.id.start).setOnClickListener(v -> {
                      if (Build.VERSION.SDK_INT >= 23 && !Settings.canDrawOverlays(this)) {
                          startActivity(new Intent(
                              Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                              Uri.parse("package:" + getPackageName())));
                          return;
                      }

                      int m = parse(min.getText().toString());
                      int s = parse(sec.getText().toString());

                      Intent i = new Intent(this, TimerService.class);
                      i.putExtra("seconds", m * 60 + s);
                      i.putExtra("size", size.getProgress() + 1);

                      if (Build.VERSION.SDK_INT >= 26) startForegroundService(i);
                      else startService(i);
                  });
              }

              int parse(String s) {
                  try { return Integer.parseInt(s); }
                  catch(Exception e) { return 0; }
              }
          }
          EOF

          # -----------------------------
          # TIMER SERVICE (DEX SAFE)
          # -----------------------------
          cat > app/src/main/java/com/yks/timer/TimerService.java <<'EOF'
          package com.yks.timer;

          import android.app.*;
          import android.content.*;
          import android.graphics.*;
          import android.media.*;
          import android.os.*;
          import android.view.*;
          import android.widget.*;

          public class TimerService extends Service {

              WindowManager wm;
              View overlay;
              int total;
              int size;
              boolean running = false;
              CountDownTimer timer;

              @Override public IBinder onBind(Intent i){ return null; }

              @Override public void onCreate(){
                  super.onCreate();
                  wm = (WindowManager)getSystemService(WINDOW_SERVICE);
                  startForeground(1, notif());
              }

              @Override public int onStartCommand(Intent i,int f,int id){
                  total = i.getIntExtra("seconds",60);
                  size  = i.getIntExtra("size",40);
                  if(overlay==null) show();
                  return START_STICKY;
              }

              void show(){
                  overlay = LayoutInflater.from(this)
                      .inflate(android.R.layout.simple_list_item_1,null);

                  TextView tv = (TextView)overlay.findViewById(android.R.id.text1);
                  tv.setTextSize(size/2f);
                  tv.setText("00:00");
                  tv.setBackgroundColor(0xFFFFFFFF);
                  tv.setPadding(20,20,20,20);

                  WindowManager.LayoutParams p =
                      new WindowManager.LayoutParams(
                          WindowManager.LayoutParams.WRAP_CONTENT,
                          WindowManager.LayoutParams.WRAP_CONTENT,
                          WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
                          WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
                          PixelFormat.TRANSLUCENT);

                  p.gravity = Gravity.TOP|Gravity.LEFT;

                  overlay.setOnTouchListener(new View.OnTouchListener(){
                      int x,y; float tx,ty;
                      public boolean onTouch(View v, MotionEvent e){
                          if(e.getAction()==MotionEvent.ACTION_DOWN){
                              x=p.x; y=p.y;
                              tx=e.getRawX(); ty=e.getRawY();
                              return true;
                          }
                          if(e.getAction()==MotionEvent.ACTION_MOVE){
                              p.x = Math.max(0, x+(int)(e.getRawX()-tx));
                              p.y = Math.max(0, y+(int)(e.getRawY()-ty));
                              wm.updateViewLayout(overlay,p);
                              return true;
                          }
                          return false;
                      }
                  });

                  wm.addView(overlay,p);
                  startTimer(tv);
              }

              void startTimer(TextView tv){
                  if(timer!=null) timer.cancel();
                  running=true;

                  timer = new CountDownTimer(total*1000,1000){
                      public void onTick(long ms){
                          int s=(int)(ms/1000);
                          tv.setText(String.format("%02d:%02d",s/60,s%60));
                      }
                      public void onFinish(){
                          ding(); ding();
                      }
                  }.start();
              }

              void ding(){
                  ToneGenerator t = new ToneGenerator(AudioManager.STREAM_NOTIFICATION,100);
                  t.startTone(ToneGenerator.TONE_PROP_BEEP,150);
              }

              Notification notif(){
                  return new Notification.Builder(this,"")
                      .setContentTitle("YKS Sayaç")
                      .setSmallIcon(android.R.drawable.ic_dialog_info)
                      .build();
              }

              @Override public void onDestroy(){
                  if(timer!=null) timer.cancel();
                  if(overlay!=null) wm.removeView(overlay);
              }
          }
          EOF

          # -----------------------------
          # ICON (VALID PNG HEADER)
          # -----------------------------
          printf '\x89PNG\r\n\x1a\n' > app/src/main/res/mipmap-mdpi/ic_launcher.png
          cp app/src/main/res/mipmap-mdpi/ic_launcher.png app/src/main/res/mipmap-hdpi/ic_launcher.png
          cp app/src/main/res/mipmap-mdpi/ic_launcher.png app/src/main/res/mipmap-xhdpi/ic_launcher.png
          cp app/src/main/res/mipmap-mdpi/ic_launcher.png app/src/main/res/mipmap-xxhdpi/ic_launcher.png

      - name: Build APK
        run: gradle assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: YKS-Timer-APK
          path: app/build/outputs/apk/debug/app-debug.apk
