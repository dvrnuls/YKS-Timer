name: Build Offline APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Gradle 8.2
        shell: bash
        run: |
          set -euo pipefail
          GRADLE_VERSION="8.2"
          curl -fsSL -o gradle.zip "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
          unzip -q gradle.zip
          echo "${PWD}/gradle-${GRADLE_VERSION}/bin" >> "$GITHUB_PATH"

      - name: Generate Android project (no INTERNET permission, no 3rd-party libs)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import os, struct, zlib, binascii

          def write_text(path: str, content: str):
              p = Path(path)
              p.parent.mkdir(parents=True, exist_ok=True)
              p.write_text(content, encoding="utf-8")

          def write_png(path: str, wpx: int=48, hpx: int=48, rgba=(25,118,210,255)):
              r,g,b,a = rgba
              raw = b"".join((b"\x00" + bytes([r,g,b,a]) * wpx) for _ in range(hpx))
              comp = zlib.compress(raw, 9)
              def chunk(tag, data):
                  return (struct.pack(">I", len(data)) + tag + data +
                          struct.pack(">I", binascii.crc32(tag + data) & 0xffffffff))
              sig = b"\x89PNG\r\n\x1a\n"
              ihdr = struct.pack(">IIBBBBB", wpx, hpx, 8, 6, 0, 0, 0)
              png = sig + chunk(b"IHDR", ihdr) + chunk(b"IDAT", comp) + chunk(b"IEND", b"")
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, "wb") as f:
                  f.write(png)

          for d in [
              "app/src/main/res/mipmap-mdpi",
              "app/src/main/res/mipmap-hdpi",
              "app/src/main/res/mipmap-xhdpi",
              "app/src/main/res/mipmap-xxhdpi",
              "app/src/main/res/mipmap-xxxhdpi",
          ]:
              write_png(f"{d}/ic_launcher.png")
              write_png(f"{d}/ic_launcher_round.png")

          write_text("build.gradle", """plugins {
              id 'com.android.application' version '8.2.2' apply false
          }
          """)

          write_text("settings.gradle", """pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "YKS-Timer"
          include ':app'
          """)

          write_text("gradle.properties", """org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=false
          android.enableJetifier=false
          """)

          write_text("app/build.gradle", """plugins { id 'com.android.application' }

          android {
              namespace 'com.yks.timer'
              compileSdk 34

              defaultConfig {
                  applicationId "com.yks.timer"
                  minSdk 23
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  debug { debuggable true }
                  release { minifyEnabled false }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
          }

          dependencies {
          }
          """)

          write_text("app/src/main/AndroidManifest.xml", """<?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">

              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:label="@string/app_name"
                  android:supportsRtl="true"
                  android:theme="@android:style/Theme.DeviceDefault.Light.NoActionBar">

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>

                  <service
                      android:name=".TimerService"
                      android:exported="false"
                      android:foregroundServiceType="dataSync" />
              </application>

          </manifest>
          """)

          # --- SNIP ---
          # TÜM DOSYALAR AYNI, SADECE AŞAĞIDAKİ METOT DÜZELTİLDİ
          # --- SNIP ---

          write_text("app/src/main/java/com/yks/timer/TimerService.java", """package com.yks.timer;

          import android.app.*;
          import android.content.*;
          import android.graphics.*;
          import android.media.*;
          import android.os.*;
          import android.view.*;
          import android.widget.*;

          public class TimerService extends Service {

              // ... (üst kısımlar DEĞİŞMEDİ)

              private int[] getScreenSize() {
                  try {
                      if (Build.VERSION.SDK_INT >= 30) {
                          WindowMetrics m = windowManager.getMaximumWindowMetrics();
                          Rect b = m.getBounds();
                          return new int[]{ b.width(), b.height() };
                      } else {
                          Display d = windowManager.getDefaultDisplay();
                          Point p = new Point();
                          d.getRealSize(p);
                          return new int[]{ p.x, p.y };
                      }
                  } catch (Exception e) {
                      return new int[]{ 1080, 1920 };
                  }
              }

              // ... (ALT KISIMLAR DEĞİŞMEDİ)
          }
          """)

          PY

      - name: Build Debug APK (installable)
        shell: bash
        run: |
          set -euo pipefail
          gradle :app:assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: YKS-Timer-APK
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: errorname: Build Offline APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Gradle 8.2
        shell: bash
        run: |
          set -euo pipefail
          GRADLE_VERSION="8.2"
          curl -fsSL -o gradle.zip "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
          unzip -q gradle.zip
          echo "${PWD}/gradle-${GRADLE_VERSION}/bin" >> "$GITHUB_PATH"

      - name: Generate Android project (no INTERNET permission, no 3rd-party libs)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import os, struct, zlib, binascii

          def write_text(path: str, content: str):
              p = Path(path)
              p.parent.mkdir(parents=True, exist_ok=True)
              p.write_text(content, encoding="utf-8")

          def write_png(path: str, wpx: int=48, hpx: int=48, rgba=(25,118,210,255)):
              r,g,b,a = rgba
              raw = b"".join((b"\x00" + bytes([r,g,b,a]) * wpx) for _ in range(hpx))
              comp = zlib.compress(raw, 9)
              def chunk(tag, data):
                  return (struct.pack(">I", len(data)) + tag + data +
                          struct.pack(">I", binascii.crc32(tag + data) & 0xffffffff))
              sig = b"\x89PNG\r\n\x1a\n"
              ihdr = struct.pack(">IIBBBBB", wpx, hpx, 8, 6, 0, 0, 0)
              png = sig + chunk(b"IHDR", ihdr) + chunk(b"IDAT", comp) + chunk(b"IEND", b"")
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, "wb") as f:
                  f.write(png)

          for d in [
              "app/src/main/res/mipmap-mdpi",
              "app/src/main/res/mipmap-hdpi",
              "app/src/main/res/mipmap-xhdpi",
              "app/src/main/res/mipmap-xxhdpi",
              "app/src/main/res/mipmap-xxxhdpi",
          ]:
              write_png(f"{d}/ic_launcher.png")
              write_png(f"{d}/ic_launcher_round.png")

          write_text("build.gradle", """plugins {
              id 'com.android.application' version '8.2.2' apply false
          }
          """)

          write_text("settings.gradle", """pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "YKS-Timer"
          include ':app'
          """)

          write_text("gradle.properties", """org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=false
          android.enableJetifier=false
          """)

          write_text("app/build.gradle", """plugins { id 'com.android.application' }

          android {
              namespace 'com.yks.timer'
              compileSdk 34

              defaultConfig {
                  applicationId "com.yks.timer"
                  minSdk 23
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  debug { debuggable true }
                  release { minifyEnabled false }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
          }

          dependencies {
          }
          """)

          write_text("app/src/main/AndroidManifest.xml", """<?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">

              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:label="@string/app_name"
                  android:supportsRtl="true"
                  android:theme="@android:style/Theme.DeviceDefault.Light.NoActionBar">

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>

                  <service
                      android:name=".TimerService"
                      android:exported="false"
                      android:foregroundServiceType="dataSync" />
              </application>

          </manifest>
          """)

          # --- SNIP ---
          # TÜM DOSYALAR AYNI, SADECE AŞAĞIDAKİ METOT DÜZELTİLDİ
          # --- SNIP ---

          write_text("app/src/main/java/com/yks/timer/TimerService.java", """package com.yks.timer;

          import android.app.*;
          import android.content.*;
          import android.graphics.*;
          import android.media.*;
          import android.os.*;
          import android.view.*;
          import android.widget.*;

          public class TimerService extends Service {

              // ... (üst kısımlar DEĞİŞMEDİ)

              private int[] getScreenSize() {
                  try {
                      if (Build.VERSION.SDK_INT >= 30) {
                          WindowMetrics m = windowManager.getMaximumWindowMetrics();
                          Rect b = m.getBounds();
                          return new int[]{ b.width(), b.height() };
                      } else {
                          Display d = windowManager.getDefaultDisplay();
                          Point p = new Point();
                          d.getRealSize(p);
                          return new int[]{ p.x, p.y };
                      }
                  } catch (Exception e) {
                      return new int[]{ 1080, 1920 };
                  }
              }

              // ... (ALT KISIMLAR DEĞİŞMEDİ)
          }
          """)

          PY

      - name: Build Debug APK (installable)
        shell: bash
        run: |
          set -euo pipefail
          gradle :app:assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: YKS-Timer-APK
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error
