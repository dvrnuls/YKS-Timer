name: Build APK (Offline App)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate Android project (no-internet app)
        shell: bash
        run: |
          set -euo pipefail

          # --- Project structure ---
          mkdir -p app/src/main/java/com/yks/timer
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/mipmap-mdpi
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-xhdpi
          mkdir -p app/src/main/res/mipmap-xxhdpi
          mkdir -p app/src/main/res/mipmap-xxxhdpi
          mkdir -p gradle/wrapper

          # --- Create VALID PNG launcher icons (AAPT2-safe) via python (no external libs) ---
          python3 - <<'PY'
          import os, struct, zlib, binascii

          def png_bytes(w, h, rgba):
              raw = b''.join((b'\x00' + rgba * w) for _ in range(h))  # filter byte 0 each row
              comp = zlib.compress(raw, 9)

              def chunk(tag, data):
                  return (struct.pack(">I", len(data)) + tag + data +
                          struct.pack(">I", binascii.crc32(tag + data) & 0xffffffff))

              sig = b'\x89PNG\r\n\x1a\n'
              ihdr = struct.pack(">IIBBBBB", w, h, 8, 6, 0, 0, 0)  # 8-bit RGBA
              return sig + chunk(b'IHDR', ihdr) + chunk(b'IDAT', comp) + chunk(b'IEND', b'')

          # 48x48 solid blue icon
          data = png_bytes(48, 48, bytes([25, 118, 210, 255]))

          dirs = [
              "app/src/main/res/mipmap-mdpi",
              "app/src/main/res/mipmap-hdpi",
              "app/src/main/res/mipmap-xhdpi",
              "app/src/main/res/mipmap-xxhdpi",
              "app/src/main/res/mipmap-xxxhdpi",
          ]
          for d in dirs:
              os.makedirs(d, exist_ok=True)
              for name in ("ic_launcher.png", "ic_launcher_round.png"):
                  with open(os.path.join(d, name), "wb") as f:
                      f.write(data)
          PY

          # --- Gradle (root) ---
          cat > build.gradle << 'EOFROOT'
          plugins {
              id 'com.android.application' version '8.2.2' apply false
              id 'org.jetbrains.kotlin.android' version '1.9.22' apply false
          }
          EOFROOT

          cat > settings.gradle << 'EOFSETTINGS'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "YKS-Timer"
          include ':app'
          EOFSETTINGS

          cat > gradle.properties << 'EOFPROPS'
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=false
          android.enableJetifier=false
          kotlin.code.style=official
          EOFPROPS

          # --- App Gradle ---
          cat > app/build.gradle << 'EOFAPP'
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }

          android {
              namespace 'com.yks.timer'
              compileSdk 34

              defaultConfig {
                  applicationId "com.yks.timer"
                  minSdk 23
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  debug {
                      debuggable true
                  }
                  release {
                      minifyEnabled false
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }

              kotlinOptions {
                  jvmTarget = '1.8'
              }
          }

          dependencies {
              // Intentionally empty: no third-party UI libs, no networking libs.
          }
          EOFAPP

          # --- AndroidManifest (NO INTERNET permission) ---
          cat > app/src/main/AndroidManifest.xml << 'EOFMANIFEST'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">

              <!-- Overlay + Foreground service -->
              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <!-- Intentionally NO android.permission.INTERNET -->

              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:label="@string/app_name"
                  android:supportsRtl="true"
                  android:theme="@android:style/Theme.DeviceDefault.Light.NoActionBar">

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>

                  <service
                      android:name=".TimerService"
                      android:exported="false" />
              </application>

          </manifest>
          EOFMANIFEST

          # --- strings.xml ---
          cat > app/src/main/res/values/strings.xml << 'EOFSTR'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">YKS Sayaç</string>
          </resources>
          EOFSTR

          # --- activity_main.xml (simple UI, no Material/AndroidX) ---
          cat > app/src/main/res/layout/activity_main.xml << 'EOFACT'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:orientation="vertical"
              android:padding="24dp">

              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="YKS Sayaç"
                  android:textSize="26sp"
                  android:textStyle="bold"
                  android:layout_marginBottom="16dp"/>

              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="Süre (dakika:saniye)"
                  android:textSize="16sp"
                  android:layout_marginBottom="8dp"/>

              <LinearLayout
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:orientation="horizontal"
                  android:layout_marginBottom="16dp">

                  <EditText
                      android:id="@+id/timeMinutes"
                      android:layout_width="0dp"
                      android:layout_height="wrap_content"
                      android:layout_weight="1"
                      android:hint="Dakika"
                      android:inputType="number"
                      android:text="1" />

                  <TextView
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="  :  "
                      android:textSize="18sp"
                      android:layout_gravity="center_vertical"/>

                  <EditText
                      android:id="@+id/timeSeconds"
                      android:layout_width="0dp"
                      android:layout_height="wrap_content"
                      android:layout_weight="1"
                      android:hint="Saniye"
                      android:inputType="number"
                      android:text="0" />
              </LinearLayout>

              <Button
                  android:id="@+id/btnStart"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:text="Sayacı Başlat" />

              <Button
                  android:id="@+id/btnStop"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:text="Durdur"
                  android:layout_marginTop="8dp" />

              <TextView
                  android:id="@+id/tvStatus"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:text="Durum: Hazır"
                  android:layout_marginTop="16dp"/>
          </LinearLayout>
          EOFACT

          # --- overlay_timer.xml ---
          cat > app/src/main/res/layout/overlay_timer.xml << 'EOFOVER'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="wrap_content"
              android:layout_height="wrap_content"
              android:orientation="vertical"
              android:padding="12dp"
              android:background="#FFFFFFFF">

              <TextView
                  android:id="@+id/tvTimer"
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="01:00"
                  android:textSize="28sp"
                  android:textStyle="bold"
                  android:layout_marginBottom="8dp"/>

              <LinearLayout
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:orientation="horizontal">

                  <Button
                      android:id="@+id/btnStart"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Başlat" />

                  <Button
                      android:id="@+id/btnPause"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Duraklat"
                      android:layout_marginStart="6dp"/>

                  <Button
                      android:id="@+id/btnReset"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Sıfırla"
                      android:layout_marginStart="6dp"/>

                  <Button
                      android:id="@+id/btnNext"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Sonraki"
                      android:layout_marginStart="6dp"/>

                  <Button
                      android:id="@+id/btnClose"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Kapat"
                      android:layout_marginStart="6dp"/>
              </LinearLayout>
          </LinearLayout>
          EOFOVER

          # --- red_screen.xml ---
          cat > app/src/main/res/layout/red_screen.xml << 'EOFRED'
          <?xml version="1.0" encoding="utf-8"?>
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:background="#CC000000">

              <LinearLayout
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:layout_gravity="center"
                  android:orientation="vertical"
                  android:padding="16dp"
                  android:gravity="center">

                  <TextView
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Süre Doldu!"
                      android:textColor="#FFFFFF"
                      android:textSize="28sp"
                      android:textStyle="bold"
                      android:layout_marginBottom="16dp"/>

                  <Button
                      android:id="@+id/btnSkip"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Soruyu Geç (2 sn)"/>
              </LinearLayout>
          </FrameLayout>
          EOFRED

          # --- MainActivity.kt (no AppCompat/AndroidX) ---
          cat > app/src/main/java/com/yks/timer/MainActivity.kt << 'EOFMAIN'
          package com.yks.timer

          import android.app.Activity
          import android.content.Intent
          import android.net.Uri
          import android.os.Build
          import android.os.Bundle
          import android.provider.Settings
          import android.widget.Button
          import android.widget.EditText
          import android.widget.TextView
          import android.widget.Toast

          class MainActivity : Activity() {

              private val REQUEST_CODE_OVERLAY = 1001

              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_main)

                  val minutesEt = findViewById<EditText>(R.id.timeMinutes)
                  val secondsEt = findViewById<EditText>(R.id.timeSeconds)
                  val statusTv = findViewById<TextView>(R.id.tvStatus)

                  findViewById<Button>(R.id.btnStart).setOnClickListener {
                      if (!checkOverlayPermission()) {
                          requestOverlayPermission()
                          return@setOnClickListener
                      }

                      val minutes = minutesEt.text.toString().toIntOrNull() ?: 0
                      val seconds = secondsEt.text.toString().toIntOrNull() ?: 0
                      val totalSeconds = minutes * 60 + seconds

                      if (totalSeconds <= 0) {
                          Toast.makeText(this, "Lütfen geçerli bir süre girin", Toast.LENGTH_SHORT).show()
                          return@setOnClickListener
                      }

                      val intent = Intent(this, TimerService::class.java).apply {
                          putExtra("TOTAL_SECONDS", totalSeconds)
                      }

                      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                          startForegroundService(intent)
                      } else {
                          startService(intent)
                      }

                      statusTv.text = "Durum: Sayaç başlatıldı"
                      Toast.makeText(this, "Sayaç başlatıldı", Toast.LENGTH_SHORT).show()
                  }

                  findViewById<Button>(R.id.btnStop).setOnClickListener {
                      stopService(Intent(this, TimerService::class.java))
                      statusTv.text = "Durum: Durduruldu"
                      Toast.makeText(this, "Durduruldu", Toast.LENGTH_SHORT).show()
                  }
              }

              private fun checkOverlayPermission(): Boolean {
                  return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                      Settings.canDrawOverlays(this)
                  } else true
              }

              private fun requestOverlayPermission() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                      val intent = Intent(
                          Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                          Uri.parse("package:$packageName")
                      )
                      startActivityForResult(intent, REQUEST_CODE_OVERLAY)
                      Toast.makeText(this, "Lütfen overlay izni verin", Toast.LENGTH_SHORT).show()
                  }
              }
          }
          EOFMAIN

          # --- TimerService.kt (stable: no crashes, timer actually starts) ---
          cat > app/src/main/java/com/yks/timer/TimerService.kt << 'EOFSERVICE'
          package com.yks.timer

          import android.app.Notification
          import android.app.NotificationChannel
          import android.app.NotificationManager
          import android.app.Service
          import android.content.Context
          import android.content.Intent
          import android.graphics.PixelFormat
          import android.os.Build
          import android.os.CountDownTimer
          import android.os.IBinder
          import android.view.Gravity
          import android.view.LayoutInflater
          import android.view.View
          import android.view.WindowManager
          import android.widget.Button
          import android.widget.TextView

          class TimerService : Service() {

              private var windowManager: WindowManager? = null
              private var overlayView: View? = null
              private var redScreenView: View? = null

              private var timer: CountDownTimer? = null
              private var totalSeconds: Long = 60
              private var initialSeconds: Long = 60
              private var isPaused: Boolean = false

              override fun onBind(intent: Intent?): IBinder? = null

              override fun onCreate() {
                  super.onCreate()
                  windowManager = getSystemService(Context.WINDOW_SERVICE) as WindowManager
                  startForeground(1, buildNotification())
              }

              override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
                  initialSeconds = (intent?.getIntExtra("TOTAL_SECONDS", 60) ?: 60).toLong()
                  if (!isPaused) {
                      totalSeconds = initialSeconds
                  } else {
                      // If paused and new start comes, treat it as new timer
                      totalSeconds = initialSeconds
                      isPaused = false
                  }

                  if (overlayView == null) {
                      showOverlay()
                  } else {
                      updateTimerText()
                      updateButtons()
                  }

                  // Start immediately (user expectation)
                  startTimer()

                  return START_STICKY
              }

              private fun showOverlay() {
                  val type = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O)
                      WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY
                  else
                      WindowManager.LayoutParams.TYPE_PHONE

                  val params = WindowManager.LayoutParams(
                      WindowManager.LayoutParams.WRAP_CONTENT,
                      WindowManager.LayoutParams.WRAP_CONTENT,
                      type,
                      WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
                      PixelFormat.TRANSLUCENT
                  ).apply {
                      gravity = Gravity.TOP or Gravity.END
                      x = 24
                      y = 120
                  }

                  overlayView = LayoutInflater.from(this).inflate(R.layout.overlay_timer, null)
                  windowManager?.addView(overlayView, params)

                  overlayView?.findViewById<Button>(R.id.btnStart)?.setOnClickListener {
                      if (isPaused) resumeTimer() else startTimer()
                  }
                  overlayView?.findViewById<Button>(R.id.btnPause)?.setOnClickListener { pauseTimer() }
                  overlayView?.findViewById<Button>(R.id.btnReset)?.setOnClickListener { resetTimer() }
                  overlayView?.findViewById<Button>(R.id.btnNext)?.setOnClickListener { nextQuestion() }
                  overlayView?.findViewById<Button>(R.id.btnClose)?.setOnClickListener { stopSelf() }

                  updateTimerText()
                  updateButtons()
              }

              private fun startTimer() {
                  timer?.cancel()
                  isPaused = false
                  updateButtons()

                  timer = object : CountDownTimer(totalSeconds * 1000, 1000) {
                      override fun onTick(millisUntilFinished: Long) {
                          totalSeconds = millisUntilFinished / 1000
                          updateTimerText()
                      }

                      override fun onFinish() {
                          totalSeconds = 0
                          updateTimerText()
                          showRedScreen()
                      }
                  }.start()
              }

              private fun pauseTimer() {
                  if (isPaused) return
                  isPaused = true
                  timer?.cancel()
                  updateButtons()
              }

              private fun resumeTimer() {
                  if (!isPaused) return
                  startTimer()
              }

              private fun resetTimer() {
                  timer?.cancel()
                  isPaused = true
                  totalSeconds = initialSeconds
                  updateTimerText()
                  updateButtons()
              }

              private fun nextQuestion() {
                  overlayView?.findViewById<Button>(R.id.btnNext)?.isEnabled = false
                  android.os.Handler(mainLooper).postDelayed({
                      timer?.cancel()
                      totalSeconds = initialSeconds
                      isPaused = false
                      updateTimerText()
                      startTimer()
                      overlayView?.findViewById<Button>(R.id.btnNext)?.isEnabled = true
                  }, 800)
              }

              private fun showRedScreen() {
                  if (redScreenView != null) return

                  val type = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O)
                      WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY
                  else
                      WindowManager.LayoutParams.TYPE_PHONE

                  val params = WindowManager.LayoutParams(
                      WindowManager.LayoutParams.MATCH_PARENT,
                      WindowManager.LayoutParams.MATCH_PARENT,
                      type,
                      WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
                      PixelFormat.TRANSLUCENT
                  )

                  redScreenView = LayoutInflater.from(this).inflate(R.layout.red_screen, null)
                  windowManager?.addView(redScreenView, params)

                  redScreenView?.findViewById<Button>(R.id.btnSkip)?.setOnClickListener {
                      skipQuestion()
                  }
              }

              private fun skipQuestion() {
                  redScreenView?.findViewById<Button>(R.id.btnSkip)?.isEnabled = false
                  android.os.Handler(mainLooper).postDelayed({
                      hideRedScreen()
                      totalSeconds = initialSeconds
                      isPaused = false
                      startTimer()
                  }, 2000)
              }

              private fun hideRedScreen() {
                  redScreenView?.let {
                      windowManager?.removeView(it)
                      redScreenView = null
                  }
              }

              private fun updateTimerText() {
                  val m = totalSeconds / 60
                  val s = totalSeconds % 60
                  overlayView?.findViewById<TextView>(R.id.tvTimer)?.text =
                      String.format("%02d:%02d", m, s)
              }

              private fun updateButtons() {
                  overlayView?.findViewById<Button>(R.id.btnStart)?.isEnabled = isPaused
                  overlayView?.findViewById<Button>(R.id.btnPause)?.isEnabled = !isPaused
              }

              private fun buildNotification(): Notification {
                  val channelId = "timer_channel"
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                      val nm = getSystemService(NotificationManager::class.java)
                      val ch = NotificationChannel(channelId, "YKS Sayaç", NotificationManager.IMPORTANCE_LOW)
                      nm.createNotificationChannel(ch)
                      return Notification.Builder(this, channelId)
                          .setContentTitle("YKS Sayaç")
                          .setContentText("Sayaç çalışıyor")
                          .setSmallIcon(android.R.drawable.ic_dialog_info)
                          .build()
                  }
                  @Suppress("DEPRECATION")
                  return Notification.Builder(this)
                      .setContentTitle("YKS Sayaç")
                      .setContentText("Sayaç çalışıyor")
                      .setSmallIcon(android.R.drawable.ic_dialog_info)
                      .build()
              }

              override fun onDestroy() {
                  super.onDestroy()
                  timer?.cancel()
                  overlayView?.let { windowManager?.removeView(it) }
                  overlayView = null
                  hideRedScreen()
              }
          }
          EOFSERVICE

          # --- Gradle Wrapper ---
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOFWRAP'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOFWRAP

          # Wrapper jar (build-time tool)
          curl -fsSL -o gradle/wrapper/gradle-wrapper.jar \
            https://raw.githubusercontent.com/gradle/gradle/v8.2.0/gradle/wrapper/gradle-wrapper.jar

          cat > gradlew << 'EOFGRADLEW'
          #!/bin/sh
          set -e
          APP_HOME="$(cd "$(dirname "$0")" && pwd)"
          CLASSPATH="$APP_HOME/gradle/wrapper/gradle-wrapper.jar"

          JAVA_CMD="${JAVA_HOME}/bin/java"
          if [ ! -x "$JAVA_CMD" ]; then
            JAVA_CMD=java
          fi

          exec "$JAVA_CMD" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"
          EOFGRADLEW
          chmod +x gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Build Debug APK (installable)
        run: ./gradlew :app:assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: YKS-Timer-APK
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error
