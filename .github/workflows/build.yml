name: Build Offline APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Install Gradle (official distribution)
        shell: bash
        run: |
          set -e
          GRADLE_VERSION="8.2"
          curl -fsSL -o gradle.zip "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
          unzip -q gradle.zip
          echo "${PWD}/gradle-${GRADLE_VERSION}/bin" >> "$GITHUB_PATH"

      - name: Generate project (repo can be empty)
        shell: bash
        run: |
          set -euo pipefail

          # --- Structure ---
          mkdir -p app/src/main/java/com/yks/timer
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/mipmap-mdpi
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-xhdpi
          mkdir -p app/src/main/res/mipmap-xxhdpi
          mkdir -p app/src/main/res/mipmap-xxxhdpi

          # --- VALID PNG icons (AAPT2-safe), no external libs ---
          python3 - <<'PY'
          import os, struct, zlib, binascii

          def png_bytes(w, h, rgba):
              raw = b''.join((b'\x00' + rgba * w) for _ in range(h))
              comp = zlib.compress(raw, 9)

              def chunk(tag, data):
                  return (struct.pack(">I", len(data)) + tag + data +
                          struct.pack(">I", binascii.crc32(tag + data) & 0xffffffff))

              sig = b'\x89PNG\r\n\x1a\n'
              ihdr = struct.pack(">IIBBBBB", w, h, 8, 6, 0, 0, 0)
              return sig + chunk(b'IHDR', ihdr) + chunk(b'IDAT', comp) + chunk(b'IEND', b'')

          data = png_bytes(48, 48, bytes([25, 118, 210, 255]))
          dirs = [
              "app/src/main/res/mipmap-mdpi",
              "app/src/main/res/mipmap-hdpi",
              "app/src/main/res/mipmap-xhdpi",
              "app/src/main/res/mipmap-xxhdpi",
              "app/src/main/res/mipmap-xxxhdpi",
          ]
          for d in dirs:
              os.makedirs(d, exist_ok=True)
              for name in ("ic_launcher.png", "ic_launcher_round.png"):
                  with open(os.path.join(d, name), "wb") as f:
                      f.write(data)
          PY

          # --- Gradle files ---
          cat > build.gradle << 'EOF'
          plugins {
              id 'com.android.application' version '8.2.2' apply false
          }
          EOF

          cat > settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "YKS-Timer"
          include ':app'
          EOF

          cat > gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=false
          android.enableJetifier=false
          EOF

          cat > app/build.gradle << 'EOF'
          plugins {
              id 'com.android.application'
          }

          android {
              namespace 'com.yks.timer'
              compileSdk 34

              defaultConfig {
                  applicationId "com.yks.timer"
                  minSdk 23
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  debug { debuggable true }
                  release { minifyEnabled false }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
          }

          dependencies {
              // No third-party libs. No networking libs.
          }
          EOF

          # --- AndroidManifest: NO INTERNET permission + correct FGS type/permission ---
          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">

              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
              <!-- IMPORTANT: No INTERNET permission on purpose -->

              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:label="@string/app_name"
                  android:supportsRtl="true"
                  android:theme="@android:style/Theme.DeviceDefault.Light.NoActionBar">

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>

                  <service
                      android:name=".TimerService"
                      android:exported="false"
                      android:foregroundServiceType="dataSync" />
              </application>

          </manifest>
          EOF

          # --- strings.xml ---
          cat > app/src/main/res/values/strings.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">YKS Sayaç</string>
          </resources>
          EOF

          # --- activity_main.xml ---
          cat > app/src/main/res/layout/activity_main.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:orientation="vertical"
              android:padding="24dp">

              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="YKS Sayaç"
                  android:textSize="26sp"
                  android:textStyle="bold"
                  android:layout_marginBottom="16dp"/>

              <TextView
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="Süre (dakika:saniye)"
                  android:textSize="16sp"
                  android:layout_marginBottom="8dp"/>

              <LinearLayout
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:orientation="horizontal"
                  android:layout_marginBottom="16dp">

                  <EditText
                      android:id="@+id/timeMinutes"
                      android:layout_width="0dp"
                      android:layout_height="wrap_content"
                      android:layout_weight="1"
                      android:hint="Dakika"
                      android:inputType="number"
                      android:text="1" />

                  <TextView
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="  :  "
                      android:textSize="18sp"
                      android:layout_gravity="center_vertical"/>

                  <EditText
                      android:id="@+id/timeSeconds"
                      android:layout_width="0dp"
                      android:layout_height="wrap_content"
                      android:layout_weight="1"
                      android:hint="Saniye"
                      android:inputType="number"
                      android:text="0" />
              </LinearLayout>

              <Button
                  android:id="@+id/btnStart"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:text="Sayacı Başlat" />

              <Button
                  android:id="@+id/btnStop"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:text="Durdur"
                  android:layout_marginTop="8dp" />

              <TextView
                  android:id="@+id/tvStatus"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:text="Durum: Hazır"
                  android:layout_marginTop="16dp"/>
          </LinearLayout>
          EOF

          # --- overlay_timer.xml ---
          cat > app/src/main/res/layout/overlay_timer.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="wrap_content"
              android:layout_height="wrap_content"
              android:orientation="vertical"
              android:padding="12dp"
              android:background="#FFFFFFFF">

              <TextView
                  android:id="@+id/tvTimer"
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="01:00"
                  android:textSize="28sp"
                  android:textStyle="bold"
                  android:layout_marginBottom="8dp"/>

              <LinearLayout
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:orientation="horizontal">

                  <Button
                      android:id="@+id/btnStart"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Başlat" />

                  <Button
                      android:id="@+id/btnPause"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Duraklat"
                      android:layout_marginStart="6dp"/>

                  <Button
                      android:id="@+id/btnReset"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Sıfırla"
                      android:layout_marginStart="6dp"/>

                  <Button
                      android:id="@+id/btnNext"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Sonraki"
                      android:layout_marginStart="6dp"/>

                  <Button
                      android:id="@+id/btnClose"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Kapat"
                      android:layout_marginStart="6dp"/>
              </LinearLayout>
          </LinearLayout>
          EOF

          # --- red_screen.xml ---
          cat > app/src/main/res/layout/red_screen.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:background="#CC000000">

              <LinearLayout
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:layout_gravity="center"
                  android:orientation="vertical"
                  android:padding="16dp"
                  android:gravity="center">

                  <TextView
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Süre Doldu!"
                      android:textColor="#FFFFFF"
                      android:textSize="28sp"
                      android:textStyle="bold"
                      android:layout_marginBottom="16dp"/>

                  <Button
                      android:id="@+id/btnSkip"
                      android:layout_width="wrap_content"
                      android:layout_height="wrap_content"
                      android:text="Soruyu Geç (2 sn)"/>
              </LinearLayout>
          </FrameLayout>
          EOF

          # --- MainActivity.java ---
          cat > app/src/main/java/com/yks/timer/MainActivity.java << 'EOF'
          package com.yks.timer;

          import android.Manifest;
          import android.app.Activity;
          import android.content.Intent;
          import android.content.pm.PackageManager;
          import android.net.Uri;
          import android.os.Build;
          import android.os.Bundle;
          import android.provider.Settings;
          import android.widget.Button;
          import android.widget.EditText;
          import android.widget.TextView;
          import android.widget.Toast;

          public class MainActivity extends Activity {

              private static final int REQ_OVERLAY = 1001;
              private static final int REQ_NOTIF = 1002;

              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);

                  if (Build.VERSION.SDK_INT >= 33) {
                      if (checkSelfPermission(Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {
                          requestPermissions(new String[]{Manifest.permission.POST_NOTIFICATIONS}, REQ_NOTIF);
                      }
                  }

                  final EditText minutesEt = findViewById(R.id.timeMinutes);
                  final EditText secondsEt = findViewById(R.id.timeSeconds);
                  final TextView statusTv = findViewById(R.id.tvStatus);

                  Button startBtn = findViewById(R.id.btnStart);
                  Button stopBtn = findViewById(R.id.btnStop);

                  startBtn.setOnClickListener(v -> {
                      if (!checkOverlayPermission()) {
                          requestOverlayPermission();
                          return;
                      }

                      int minutes = 0, seconds = 0;
                      try { minutes = Integer.parseInt(minutesEt.getText().toString().trim()); } catch (Exception ignored) {}
                      try { seconds = Integer.parseInt(secondsEt.getText().toString().trim()); } catch (Exception ignored) {}

                      int totalSeconds = minutes * 60 + seconds;
                      if (totalSeconds <= 0) {
                          Toast.makeText(this, "Lütfen geçerli bir süre girin", Toast.LENGTH_SHORT).show();
                          return;
                      }

                      Intent intent = new Intent(this, TimerService.class);
                      intent.putExtra("TOTAL_SECONDS", totalSeconds);

                      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                          startForegroundService(intent);
                      } else {
                          startService(intent);
                      }

                      statusTv.setText("Durum: Sayaç başlatıldı");
                      Toast.makeText(this, "Sayaç başlatıldı", Toast.LENGTH_SHORT).show();
                  });

                  stopBtn.setOnClickListener(v -> {
                      stopService(new Intent(this, TimerService.class));
                      statusTv.setText("Durum: Durduruldu");
                      Toast.makeText(this, "Durduruldu", Toast.LENGTH_SHORT).show();
                  });
              }

              private boolean checkOverlayPermission() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                      return Settings.canDrawOverlays(this);
                  }
                  return true;
              }

              private void requestOverlayPermission() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                      Intent intent = new Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                              Uri.parse("package:" + getPackageName()));
                      startActivityForResult(intent, REQ_OVERLAY);
                      Toast.makeText(this, "Lütfen overlay izni verin", Toast.LENGTH_SHORT).show();
                  }
              }
          }
          EOF

          # --- TimerService.java ---
          cat > app/src/main/java/com/yks/timer/TimerService.java << 'EOF'
          package com.yks.timer;

          import android.app.Notification;
          import android.app.NotificationChannel;
          import android.app.NotificationManager;
          import android.app.Service;
          import android.content.Context;
          import android.content.Intent;
          import android.graphics.PixelFormat;
          import android.os.Build;
          import android.os.CountDownTimer;
          import android.os.Handler;
          import android.os.IBinder;
          import android.view.Gravity;
          import android.view.LayoutInflater;
          import android.view.View;
          import android.view.WindowManager;
          import android.widget.Button;
          import android.widget.TextView;

          public class TimerService extends Service {

              private static final String CHANNEL_ID = "timer_channel";

              private WindowManager windowManager;
              private View overlayView;
              private View redScreenView;

              private CountDownTimer timer;
              private long totalSeconds = 60;
              private long initialSeconds = 60;
              private boolean isPaused = false;

              @Override
              public IBinder onBind(Intent intent) { return null; }

              @Override
              public void onCreate() {
                  super.onCreate();
                  windowManager = (WindowManager) getSystemService(Context.WINDOW_SERVICE);
                  startForeground(1, buildNotification());
              }

              @Override
              public int onStartCommand(Intent intent, int flags, int startId) {
                  int sec = (intent != null) ? intent.getIntExtra("TOTAL_SECONDS", 60) : 60;
                  initialSeconds = sec;
                  totalSeconds = initialSeconds;
                  isPaused = false;

                  if (overlayView == null) {
                      showOverlay();
                  } else {
                      updateTimerText();
                      updateButtons();
                  }

                  // Start immediately
                  startTimer();

                  return START_STICKY;
              }

              private void showOverlay() {
                  int type = (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O)
                          ? WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY
                          : WindowManager.LayoutParams.TYPE_PHONE;

                  WindowManager.LayoutParams params = new WindowManager.LayoutParams(
                          WindowManager.LayoutParams.WRAP_CONTENT,
                          WindowManager.LayoutParams.WRAP_CONTENT,
                          type,
                          WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
                          PixelFormat.TRANSLUCENT
                  );
                  params.gravity = Gravity.TOP | Gravity.END;
                  params.x = 24;
                  params.y = 120;

                  overlayView = LayoutInflater.from(this).inflate(R.layout.overlay_timer, null);
                  windowManager.addView(overlayView, params);

                  Button btnStart = overlayView.findViewById(R.id.btnStart);
                  Button btnPause = overlayView.findViewById(R.id.btnPause);
                  Button btnReset = overlayView.findViewById(R.id.btnReset);
                  Button btnNext  = overlayView.findViewById(R.id.btnNext);
                  Button btnClose = overlayView.findViewById(R.id.btnClose);

                  btnStart.setOnClickListener(v -> { if (isPaused) resumeTimer(); else startTimer(); });
                  btnPause.setOnClickListener(v -> pauseTimer());
                  btnReset.setOnClickListener(v -> resetTimer());
                  btnNext.setOnClickListener(v -> nextQuestion());
                  btnClose.setOnClickListener(v -> stopSelf());

                  updateTimerText();
                  updateButtons();
              }

              private void startTimer() {
                  if (timer != null) timer.cancel();
                  isPaused = false;
                  updateButtons();

                  timer = new CountDownTimer(totalSeconds * 1000, 1000) {
                      @Override public void onTick(long millisUntilFinished) {
                          totalSeconds = millisUntilFinished / 1000;
                          updateTimerText();
                      }
                      @Override public void onFinish() {
                          totalSeconds = 0;
                          updateTimerText();
                          showRedScreen();
                      }
                  }.start();
              }

              private void pauseTimer() {
                  if (isPaused) return;
                  isPaused = true;
                  if (timer != null) timer.cancel();
                  updateButtons();
              }

              private void resumeTimer() {
                  if (!isPaused) return;
                  startTimer();
              }

              private void resetTimer() {
                  if (timer != null) timer.cancel();
                  isPaused = true;
                  totalSeconds = initialSeconds;
                  updateTimerText();
                  updateButtons();
              }

              private void nextQuestion() {
                  Button btnNext = overlayView.findViewById(R.id.btnNext);
                  btnNext.setEnabled(false);

                  new Handler(getMainLooper()).postDelayed(() -> {
                      if (timer != null) timer.cancel();
                      totalSeconds = initialSeconds;
                      isPaused = false;
                      updateTimerText();
                      startTimer();
                      btnNext.setEnabled(true);
                  }, 800);
              }

              private void showRedScreen() {
                  if (redScreenView != null) return;

                  int type = (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O)
                          ? WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY
                          : WindowManager.LayoutParams.TYPE_PHONE;

                  WindowManager.LayoutParams params = new WindowManager.LayoutParams(
                          WindowManager.LayoutParams.MATCH_PARENT,
                          WindowManager.LayoutParams.MATCH_PARENT,
                          type,
                          WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
                          PixelFormat.TRANSLUCENT
                  );

                  redScreenView = LayoutInflater.from(this).inflate(R.layout.red_screen, null);
                  windowManager.addView(redScreenView, params);

                  Button btnSkip = redScreenView.findViewById(R.id.btnSkip);
                  btnSkip.setOnClickListener(v -> skipQuestion());
              }

              private void skipQuestion() {
                  Button btnSkip = redScreenView.findViewById(R.id.btnSkip);
                  btnSkip.setEnabled(false);

                  new Handler(getMainLooper()).postDelayed(() -> {
                      hideRedScreen();
                      totalSeconds = initialSeconds;
                      isPaused = false;
                      startTimer();
                  }, 2000);
              }

              private void hideRedScreen() {
                  if (redScreenView != null) {
                      windowManager.removeView(redScreenView);
                      redScreenView = null;
                  }
              }

              private void updateTimerText() {
                  if (overlayView == null) return;
                  long m = totalSeconds / 60;
                  long s = totalSeconds % 60;
                  TextView tv = overlayView.findViewById(R.id.tvTimer);
                  tv.setText(String.format("%02d:%02d", m, s));
              }

              private void updateButtons() {
                  if (overlayView == null) return;
                  overlayView.findViewById(R.id.btnStart).setEnabled(isPaused);
                  overlayView.findViewById(R.id.btnPause).setEnabled(!isPaused);
              }

              private Notification buildNotification() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                      NotificationManager nm = getSystemService(NotificationManager.class);
                      NotificationChannel ch = new NotificationChannel(
                              CHANNEL_ID, "YKS Sayaç", NotificationManager.IMPORTANCE_LOW
                      );
                      nm.createNotificationChannel(ch);

                      return new Notification.Builder(this, CHANNEL_ID)
                              .setContentTitle("YKS Sayaç")
                              .setContentText("Sayaç çalışıyor")
                              .setSmallIcon(android.R.drawable.ic_dialog_info)
                              .build();
                  } else {
                      return new Notification.Builder(this)
                              .setContentTitle("YKS Sayaç")
                              .setContentText("Sayaç çalışıyor")
                              .setSmallIcon(android.R.drawable.ic_dialog_info)
                              .build();
                  }
              }

              @Override
              public void onDestroy() {
                  super.onDestroy();
                  if (timer != null) timer.cancel();

                  if (overlayView != null) {
                      windowManager.removeView(overlayView);
                      overlayView = null;
                  }
                  hideRedScreen();
              }
          }
          EOF

      - name: Build Debug APK (installable)
        run: gradle :app:assembleDebug

      - name: Inspect APK (sanity)
        shell: bash
        run: |
          set -e
          ls -lh app/build/outputs/apk/debug/app-debug.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: YKS-Timer-APK
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error
