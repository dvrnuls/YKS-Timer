name: Build Offline APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Gradle 8.2
        shell: bash
        run: |
          set -euo pipefail
          GRADLE_VERSION="8.2"
          curl -fsSL -o gradle.zip "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
          unzip -q gradle.zip
          echo "${PWD}/gradle-${GRADLE_VERSION}/bin" >> "$GITHUB_PATH"

      - name: Generate Android project (no INTERNET permission, no 3rd-party libs)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          from pathlib import Path
          import os, struct, zlib, binascii

          def write_text(path: str, content: str):
              p = Path(path)
              p.parent.mkdir(parents=True, exist_ok=True)
              p.write_text(content, encoding="utf-8")

          def write_timer_icon(path: str, size: int=192):
              pixels = []
              for y in range(size):
                  row = []
                  for x in range(size):
                      cx, cy = size/2, size/2
                      dx, dy = x - cx, y - cy
                      dist = (dx*dx + dy*dy) ** 0.5
                      if dist < size * 0.45:
                          t = y / size
                          r = int(25 + t * 120)
                          g = int(118 - t * 68)
                          b = int(210 + t * 45)
                          angle = ((x - cx) / max(dist, 0.001), (y - cy) / max(dist, 0.001))
                          if (abs(angle[0]) < 0.08 and dy < 0 and dist < size * 0.35) or \
                             (abs(angle[1]) < 0.08 and dx > 0 and dist < size * 0.25):
                              r, g, b = 255, 255, 255
                          row.append((r, g, b, 255))
                      else:
                          row.append((0, 0, 0, 0))
                  pixels.append(row)
              
              raw = b"".join(b"\x00" + bytes([c for rgba in row for c in rgba]) for row in pixels)
              comp = zlib.compress(raw, 9)
              def chunk(tag, data):
                  return (struct.pack(">I", len(data)) + tag + data +
                          struct.pack(">I", binascii.crc32(tag + data) & 0xffffffff))
              sig = b"\x89PNG\r\n\x1a\n"
              ihdr = struct.pack(">IIBBBBB", size, size, 8, 6, 0, 0, 0)
              png = sig + chunk(b"IHDR", ihdr) + chunk(b"IDAT", comp) + chunk(b"IEND", b"")
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, "wb") as f:
                  f.write(png)

          # Icons
          for d, sz in {
              "app/src/main/res/mipmap-mdpi": 48,
              "app/src/main/res/mipmap-hdpi": 72,
              "app/src/main/res/mipmap-xhdpi": 96,
              "app/src/main/res/mipmap-xxhdpi": 144,
              "app/src/main/res/mipmap-xxxhdpi": 192,
          }.items():
              write_timer_icon(f"{d}/ic_launcher.png", sz)
              write_timer_icon(f"{d}/ic_launcher_round.png", sz)

          write_text("build.gradle", """plugins {
              id 'com.android.application' version '8.2.2' apply false
          }
          """)

          write_text("settings.gradle", """pluginManagement {
              repositories { google(); mavenCentral(); gradlePluginPortal() }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories { google(); mavenCentral() }
          }
          rootProject.name = "YKS-Timer"
          include ':app'
          """)

          write_text("gradle.properties", """org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=false
          android.enableJetifier=false
          """)

          write_text("app/build.gradle", """plugins { id 'com.android.application' }
          android {
              namespace 'com.yks.timer'
              compileSdk 34
              defaultConfig {
                  applicationId "com.yks.timer"
                  minSdk 23
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              buildTypes {
                  debug { debuggable true }
                  release { minifyEnabled false }
              }
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
          }
          dependencies { }
          """)

          write_text("app/src/main/AndroidManifest.xml", """<?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:label="@string/app_name"
                  android:supportsRtl="true"
                  android:theme="@android:style/Theme.DeviceDefault.Light.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <service android:name=".TimerService" android:exported="false" android:foregroundServiceType="dataSync" />
              </application>
          </manifest>
          """)

          write_text("app/src/main/res/values/strings.xml", """<?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">YKS Saya√ß</string>
              <string name="btn_start">‚ñ∂ Ba≈ülat</string>
              <string name="btn_pause">‚è∏ Duraklat</string>
              <string name="btn_reset">‚Üª Sƒ±fƒ±rla</string>
              <string name="btn_next">‚è≠ Sonraki</string>
              <string name="btn_close">‚úï Kapat</string>
              <string name="btn_apply_size">Boyutu Uygula</string>
              <string name="btn_main_start">Sayacƒ± Ba≈ülat</string>
              <string name="btn_main_stop">Durdur</string>
              <string name="time_up">‚è∞ S√úRE DOLDU!</string>
              <string name="skip">Soruyu Ge√ß</string>
          </resources>
          """)

          write_text("app/src/main/res/values/colors.xml", """<?xml version="1.0" encoding="utf-8"?>
          <resources>
              <color name="primary">#1976D2</color>
              <color name="overlay_bg">#FFFFFF</color>
              <color name="overlay_header">#F5F5F5</color>
          </resources>
          """)

          write_text("app/src/main/res/layout/activity_main.xml", """<?xml version="1.0" encoding="utf-8"?>
          <ScrollView xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:background="#FAFAFA">
              <LinearLayout
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"
                  android:orientation="vertical"
                  android:padding="24dp">
                  <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                      android:text="‚è± YKS Saya√ß" android:textSize="32sp" android:textStyle="bold"
                      android:textColor="@color/primary" android:layout_marginBottom="8dp"/>
                  <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                      android:text="Sƒ±nav sorularƒ± i√ßin profesyonel zamanlayƒ±cƒ±"
                      android:textSize="14sp" android:textColor="#757575" android:layout_marginBottom="24dp"/>
                  
                  <LinearLayout android:layout_width="match_parent" android:layout_height="wrap_content"
                      android:orientation="vertical" android:background="#FFFFFF" android:elevation="4dp"
                      android:padding="16dp" android:layout_marginBottom="16dp">
                      <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                          android:text="‚è∞ S√ºre Ayarƒ±" android:textSize="18sp" android:textStyle="bold"
                          android:textColor="@color/primary" android:layout_marginBottom="12dp"/>
                      <LinearLayout android:layout_width="match_parent" android:layout_height="wrap_content"
                          android:orientation="horizontal" android:gravity="center">
                          <EditText android:id="@+id/timeMinutes" android:layout_width="0dp"
                              android:layout_height="wrap_content" android:layout_weight="1" android:hint="Dakika"
                              android:inputType="number" android:text="1" android:textSize="24sp"
                              android:textAlignment="center" android:padding="12dp" android:background="#F5F5F5" />
                          <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                              android:text="  :  " android:textSize="28sp" android:textStyle="bold" />
                          <EditText android:id="@+id/timeSeconds" android:layout_width="0dp"
                              android:layout_height="wrap_content" android:layout_weight="1" android:hint="Saniye"
                              android:inputType="number" android:text="0" android:textSize="24sp"
                              android:textAlignment="center" android:padding="12dp" android:background="#F5F5F5" />
                      </LinearLayout>
                  </LinearLayout>

                  <LinearLayout android:layout_width="match_parent" android:layout_height="wrap_content"
                      android:orientation="vertical" android:background="#FFFFFF" android:elevation="4dp"
                      android:padding="16dp" android:layout_marginBottom="16dp">
                      <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                          android:text="üìè Y√ºzen Saya√ß Boyutu" android:textSize="18sp" android:textStyle="bold"
                          android:textColor="@color/primary" android:layout_marginBottom="8dp"/>
                      <TextView android:id="@+id/tvSize" android:layout_width="wrap_content"
                          android:layout_height="wrap_content" android:text="Boyut: 55%"
                          android:textSize="16sp" android:textColor="#424242" android:layout_marginBottom="8dp"/>
                      <SeekBar android:id="@+id/seekSize" android:layout_width="match_parent"
                          android:layout_height="wrap_content" android:max="99" android:progress="54"
                          android:layout_marginBottom="12dp" />
                      <Button android:id="@+id/btnApplySize" android:layout_width="match_parent"
                          android:layout_height="wrap_content" android:text="@string/btn_apply_size"
                          android:textColor="#FFFFFF" android:background="@color/primary" android:padding="12dp" />
                  </LinearLayout>

                  <Button android:id="@+id/btnStart" android:layout_width="match_parent"
                      android:layout_height="wrap_content" android:text="@string/btn_main_start"
                      android:textSize="18sp" android:textColor="#FFFFFF" android:background="@color/primary"
                      android:padding="16dp" android:layout_marginBottom="12dp" />
                  <Button android:id="@+id/btnStop" android:layout_width="match_parent"
                      android:layout_height="wrap_content" android:text="@string/btn_main_stop"
                      android:textSize="16sp" android:textColor="#FFFFFF" android:background="#F44336"
                      android:padding="14dp" />
                  <TextView android:id="@+id/tvStatus" android:layout_width="match_parent"
                      android:layout_height="wrap_content" android:text="‚úì Durum: Hazƒ±r"
                      android:textSize="14sp" android:textColor="#4CAF50" android:layout_marginTop="16dp"
                      android:padding="12dp" android:background="#E8F5E9"/>
              </LinearLayout>
          </ScrollView>
          """)

          write_text("app/src/main/res/layout/overlay_timer.xml", """<?xml version="1.0" encoding="utf-8"?>
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:id="@+id/rootOverlay"
              android:layout_width="wrap_content"
              android:layout_height="wrap_content"
              android:clickable="true">
              <LinearLayout android:id="@+id/overlayContent"
                  android:layout_width="wrap_content" android:layout_height="wrap_content"
                  android:orientation="vertical" android:background="@color/overlay_bg" android:elevation="8dp">
                  <LinearLayout android:id="@+id/dragHandle"
                      android:layout_width="match_parent" android:layout_height="wrap_content"
                      android:orientation="vertical" android:padding="12dp" android:background="@color/overlay_header">
                      <TextView android:id="@+id/tvTimer" android:layout_width="wrap_content"
                          android:layout_height="wrap_content" android:text="01:00" android:textSize="28sp"
                          android:textStyle="bold" android:textColor="@color/primary" android:fontFamily="monospace" />
                      <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                          android:text="‚¨ç S√ºr√ºkle" android:textSize="9sp" android:textColor="#999999" />
                  </LinearLayout>
                  <LinearLayout android:layout_width="wrap_content" android:layout_height="wrap_content"
                      android:orientation="horizontal" android:padding="6dp">
                      <Button android:id="@+id/btnToggle" android:layout_width="wrap_content"
                          android:layout_height="wrap_content" android:text="@string/btn_pause"
                          android:textSize="11sp" android:minWidth="60dp" android:padding="8dp" />
                      <Button android:id="@+id/btnReset" android:layout_width="wrap_content"
                          android:layout_height="wrap_content" android:text="@string/btn_reset"
                          android:textSize="11sp" android:minWidth="60dp" android:padding="8dp" android:layout_marginStart="4dp"/>
                      <Button android:id="@+id/btnNext" android:layout_width="wrap_content"
                          android:layout_height="wrap_content" android:text="@string/btn_next"
                          android:textSize="11sp" android:minWidth="60dp" android:padding="8dp" android:layout_marginStart="4dp"/>
                      <Button android:id="@+id/btnClose" android:layout_width="wrap_content"
                          android:layout_height="wrap_content" android:text="@string/btn_close"
                          android:textSize="11sp" android:minWidth="50dp" android:padding="8dp" android:layout_marginStart="4dp"/>
                  </LinearLayout>
              </LinearLayout>
          </FrameLayout>
          """)

          write_text("app/src/main/res/layout/red_screen.xml", """<?xml version="1.0" encoding="utf-8"?>
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="match_parent" android:background="#DDFF0000">
              <LinearLayout android:layout_width="wrap_content" android:layout_height="wrap_content"
                  android:layout_gravity="center" android:orientation="vertical" android:padding="24dp"
                  android:background="#FFFF0000" android:elevation="16dp" android:gravity="center">
                  <TextView android:layout_width="wrap_content" android:layout_height="wrap_content"
                      android:text="@string/time_up" android:textColor="#FFFFFF" android:textSize="32sp"
                      android:textStyle="bold" android:layout_marginBottom="20dp"/>
                  <Button android:id="@+id/btnSkip" android:layout_width="wrap_content"
                      android:layout_height="wrap_content" android:text="@string/skip" android:textSize="16sp"
                      android:textColor="#FF0000" android:background="#FFFFFF" android:padding="16dp" android:minWidth="200dp"/>
              </LinearLayout>
          </FrameLayout>
          """)

          write_text("app/src/main/java/com/yks/timer/MainActivity.java", """package com.yks.timer;
          import android.Manifest;
          import android.app.Activity;
          import android.content.Intent;
          import android.content.SharedPreferences;
          import android.content.pm.PackageManager;
          import android.net.Uri;
          import android.os.Build;
          import android.os.Bundle;
          import android.provider.Settings;
          import android.widget.Button;
          import android.widget.EditText;
          import android.widget.SeekBar;
          import android.widget.TextView;
          import android.widget.Toast;

          public class MainActivity extends Activity {
              private static final int REQ_OVERLAY = 1001, REQ_NOTIF = 1002;
              private static final String PREFS = "yks_timer_prefs", KEY_SIZE = "overlay_size";
              private static final int DEFAULT_SIZE = 55;

              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);

                  if (Build.VERSION.SDK_INT >= 33) {
                      if (checkSelfPermission(Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {
                          requestPermissions(new String[]{Manifest.permission.POST_NOTIFICATIONS}, REQ_NOTIF);
                      }
                  }

                  final EditText minutesEt = findViewById(R.id.timeMinutes);
                  final EditText secondsEt = findViewById(R.id.timeSeconds);
                  final TextView statusTv = findViewById(R.id.tvStatus);
                  final TextView tvSize = findViewById(R.id.tvSize);
                  final SeekBar seek = findViewById(R.id.seekSize);
                  final Button btnApply = findViewById(R.id.btnApplySize);

                  final SharedPreferences prefs = getSharedPreferences(PREFS, MODE_PRIVATE);
                  int size = clamp(prefs.getInt(KEY_SIZE, DEFAULT_SIZE), 1, 100);

                  seek.setProgress(size - 1);
                  tvSize.setText("Boyut: " + size + "%");

                  seek.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {
                      @Override public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {
                          int v = clamp(progress + 1, 1, 100);
                          tvSize.setText("Boyut: " + v + "%");
                          prefs.edit().putInt(KEY_SIZE, v).apply();
                      }
                      @Override public void onStartTrackingTouch(SeekBar seekBar) {}
                      @Override public void onStopTrackingTouch(SeekBar seekBar) {}
                  });

                  btnApply.setOnClickListener(v -> {
                      if (!checkOverlayPermission()) { requestOverlayPermission(); return; }
                      int s = clamp(prefs.getInt(KEY_SIZE, DEFAULT_SIZE), 1, 100);
                      Intent i = new Intent(this, TimerService.class);
                      i.setAction(TimerService.ACTION_UPDATE_SIZE);
                      i.putExtra(TimerService.EXTRA_OVERLAY_SIZE, s);
                      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) startForegroundService(i);
                      else startService(i);
                      statusTv.setText("‚úì Durum: Boyut uygulandƒ± (" + s + "%)");
                      Toast.makeText(this, "Boyut uygulandƒ±", Toast.LENGTH_SHORT).show();
                  });

                  findViewById(R.id.btnStart).setOnClickListener(v -> {
                      if (!checkOverlayPermission()) { requestOverlayPermission(); return; }
                      int totalSeconds = parseIntSafe(minutesEt.getText().toString()) * 60 + parseIntSafe(secondsEt.getText().toString());
                      if (totalSeconds <= 0) {
                          Toast.makeText(this, "L√ºtfen ge√ßerli bir s√ºre girin", Toast.LENGTH_SHORT).show();
                          return;
                      }
                      Intent intent = new Intent(this, TimerService.class);
                      intent.setAction(TimerService.ACTION_START_TIMER);
                      intent.putExtra(TimerService.EXTRA_TOTAL_SECONDS, totalSeconds);
                      intent.putExtra(TimerService.EXTRA_OVERLAY_SIZE, clamp(prefs.getInt(KEY_SIZE, DEFAULT_SIZE), 1, 100));
                      if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) startForegroundService(intent);
                      else startService(intent);
                      statusTv.setText("‚úì Durum: Saya√ß ba≈ülatƒ±ldƒ±");
                  });

                  findViewById(R.id.btnStop).setOnClickListener(v -> {
                      stopService(new Intent(this, TimerService.class));
                      statusTv.setText("‚úì Durum: Durduruldu");
                  });
              }

              private boolean checkOverlayPermission() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) return Settings.canDrawOverlays(this);
                  return true;
              }

              private void requestOverlayPermission() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                      startActivityForResult(new Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                              Uri.parse("package:" + getPackageName())), REQ_OVERLAY);
                      Toast.makeText(this, "L√ºtfen overlay izni verin", Toast.LENGTH_SHORT).show();
                  }
              }

              private static int parseIntSafe(String s) {
                  try { return Integer.parseInt(s.trim()); } catch (Exception e) { return 0; }
              }

              private static int clamp(int v, int lo, int hi) {
                  return v < lo ? lo : (v > hi ? hi : v);
              }
          }
          """)

          write_text("app/src/main/java/com/yks/timer/TimerService.java", """package com.yks.timer;
          import android.app.Notification;
          import android.app.NotificationChannel;
          import android.app.NotificationManager;
          import android.app.Service;
          import android.content.Context;
          import android.content.Intent;
          import android.graphics.PixelFormat;
          import android.graphics.Point;
          import android.graphics.Rect;
          import android.media.AudioManager;
          import android.media.ToneGenerator;
          import android.os.Build;
          import android.os.CountDownTimer;
          import android.os.Handler;
          import android.os.IBinder;
          import android.view.Display;
          import android.view.Gravity;
          import android.view.LayoutInflater;
          import android.view.MotionEvent;
          import android.view.View;
          import android.view.ViewGroup;
          import android.view.WindowManager;
          import android.view.WindowMetrics;
          import android.widget.Button;
          import android.widget.TextView;

          public class TimerService extends Service {
              public static final String ACTION_START_TIMER = "com.yks.timer.action.START_TIMER";
              public static final String ACTION_UPDATE_SIZE = "com.yks.timer.action.UPDATE_SIZE";
              public static final String EXTRA_TOTAL_SECONDS = "TOTAL_SECONDS";
              public static final String EXTRA_OVERLAY_SIZE = "OVERLAY_SIZE";
              private static final String CHANNEL_ID = "timer_channel";

              private WindowManager wm;
              private View overlayView, overlayContent, redScreenView;
              private WindowManager.LayoutParams overlayParams;
              private CountDownTimer timer;
              private long totalSeconds = 60, initialSeconds = 60;
              private boolean isPaused = false;
              private int sizePercent = 55;
              private int baseContentW = 0, baseContentH = 0, baseHandleH = 0;
              private final Handler handler = new Handler();
              private Runnable pendingResume;

              @Override public IBinder onBind(Intent intent) { return null; }

              @Override
              public void onCreate() {
                  super.onCreate();
                  wm = (WindowManager) getSystemService(Context.WINDOW_SERVICE);
                  startForeground(1, buildNotification());
              }

              @Override
              public int onStartCommand(Intent intent, int flags, int startId) {
                  String action = (intent != null) ? intent.getAction() : null;
                  if (ACTION_UPDATE_SIZE.equals(action)) {
                      sizePercent = clamp((intent != null) ? intent.getIntExtra(EXTRA_OVERLAY_SIZE, 55) : 55, 1, 100);
                      applyScale();
                      clampToScreen();
                      return START_NOT_STICKY;
                  }
                  if (ACTION_START_TIMER.equals(action) || action == null) {
                      initialSeconds = (intent != null) ? intent.getIntExtra(EXTRA_TOTAL_SECONDS, 60) : 60;
                      totalSeconds = initialSeconds;
                      isPaused = false;
                      sizePercent = clamp((intent != null) ? intent.getIntExtra(EXTRA_OVERLAY_SIZE, 55) : 55, 1, 100);
                      if (overlayView == null) {
                          if (!showOverlay()) { stopCompletely(); return START_NOT_STICKY; }
                      } else {
                          applyScale();
                          updateTimerText();
                          updateToggleText();
                          clampToScreen();
                      }
                      startTimer();
                  }
                  return START_NOT_STICKY;
              }

              private boolean showOverlay() {
                  try {
                      int type = (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O)
                              ? WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY
                              : WindowManager.LayoutParams.TYPE_PHONE;

                      overlayParams = new WindowManager.LayoutParams(
                              WindowManager.LayoutParams.WRAP_CONTENT,
                              WindowManager.LayoutParams.WRAP_CONTENT,
                              type,
                              WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE
                                      | WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,
                              PixelFormat.TRANSLUCENT
                      );
                      overlayParams.gravity = android.view.Gravity.TOP | android.view.Gravity.LEFT;
                      overlayParams.x = 100;
                      overlayParams.y = 100;

                      overlayView = LayoutInflater.from(this).inflate(R.layout.overlay_timer, null);
                      overlayContent = overlayView.findViewById(R.id.overlayContent);

                      if (overlayView instanceof ViewGroup) {
                          ((ViewGroup) overlayView).setClipChildren(false);
                          ((ViewGroup) overlayView).setClipToPadding(false);
                      }
                      if (overlayContent instanceof ViewGroup) {
                          ((ViewGroup) overlayContent).setClipChildren(false);
                          ((ViewGroup) overlayContent).setClipToPadding(false);
                      }

                      wm.addView(overlayView, overlayParams);

                      final View dragHandle = overlayView.findViewById(R.id.dragHandle);
                      Button btnToggle = overlayView.findViewById(R.id.btnToggle);
                      Button btnReset = overlayView.findViewById(R.id.btnReset);
                      Button btnNext = overlayView.findViewById(R.id.btnNext);
                      Button btnClose = overlayView.findViewById(R.id.btnClose);

                      btnToggle.setOnClickListener(v -> { if (isPaused) resumeTimer(); else pauseTimer(); });
                      btnReset.setOnClickListener(v -> resetTimer());
                      btnNext.setOnClickListener(v -> nextQuestion());
                      btnClose.setOnClickListener(v -> stopCompletely());

                      overlayView.post(() -> {
                          if (overlayView == null || overlayContent == null) return;
                          baseContentW = overlayContent.getWidth();
                          baseContentH = overlayContent.getHeight();
                          baseHandleH = dragHandle.getHeight();
                          applyScale();
                          int[] wh = getScreenSize();
                          setPosition(wh[0] / 3, wh[1] / 3);
                      });

                      overlayView.setOnTouchListener(new View.OnTouchListener() {
                          private boolean dragging = false;
                          private float startRawX, startRawY;
                          private int startX, startY;

                          @Override
                          public boolean onTouch(View v, MotionEvent e) {
                              if (overlayParams == null || overlayContent == null) return true;
                              float scale = sizePercent / 100.0f;
                              if (scale <= 0f) scale = 1f;

                              float contentX = overlayContent.getX();
                              float contentY = overlayContent.getY();
                              float localY = e.getY() - contentY;
                              int handlePx = (baseHandleH > 0) ? (int) Math.ceil(baseHandleH * scale) : 120;

                              switch (e.getAction()) {
                                  case MotionEvent.ACTION_DOWN:
                                      dragging = (localY >= 0f && localY <= handlePx);
                                      if (dragging) {
                                          startX = overlayParams.x;
                                          startY = overlayParams.y;
                                          startRawX = e.getRawX();
                                          startRawY = e.getRawY();
                                          return true;
                                      } else {
                                          dispatchScaled(e, scale, contentX, contentY);
                                          return true;
                                      }
                                  case MotionEvent.ACTION_MOVE:
                                      if (dragging) {
                                          int dx = (int) (e.getRawX() - startRawX);
                                          int dy = (int) (e.getRawY() - startRawY);
                                          setPosition(startX + dx, startY + dy);
                                          return true;
                                      } else {
                                          dispatchScaled(e, scale, contentX, contentY);
                                          return true;
                                      }
                                  case MotionEvent.ACTION_UP:
                                  case MotionEvent.ACTION_CANCEL:
                                      if (dragging) {
                                          dragging = false;
                                          return true;
                                      } else {
                                          dispatchScaled(e, scale, contentX, contentY);
                                          return true;
                                      }
                                  default:
                                      dispatchScaled(e, scale, contentX, contentY);
                                      return true;
                              }
                          }
                      });

                      updateTimerText();
                      updateToggleText();
                      return true;
                  } catch (Exception e) {
                      overlayView = null;
                      overlayContent = null;
                      overlayParams = null;
                      return false;
                  }
              }

              private void dispatchScaled(MotionEvent e, float scale, float contentX, float contentY) {
                  try {
                      MotionEvent ev = MotionEvent.obtain(e);
                      float lx = (e.getX() - contentX) / scale;
                      float ly = (e.getY() - contentY) / scale;
                      ev.setLocation(lx, ly);
                      overlayContent.dispatchTouchEvent(ev);
                      ev.recycle();
                  } catch (Exception ignored) {}
              }

              private void applyScale() {
                  if (overlayView == null || overlayContent == null || overlayParams == null) return;
                  float scale = sizePercent / 100.0f;
                  if (scale <= 0f) scale = 1f;

                  if (baseContentW <= 0 || baseContentH <= 0) {
                      overlayContent.measure(
                              View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED),
                              View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED)
                      );
                      baseContentW = overlayContent.getMeasuredWidth();
                      baseContentH = overlayContent.getMeasuredHeight();
                  }
                  if (baseContentW <= 0 || baseContentH <= 0) return;

                  overlayContent.setScaleX(scale);
                  overlayContent.setScaleY(scale);
                  overlayContent.setPivotX(0f);
                  overlayContent.setPivotY(0f);

                  overlayParams.width = baseContentW;
                  overlayParams.height = baseContentH;

                  try { wm.updateViewLayout(overlayView, overlayParams); } catch (Exception ignored) {}
              }

              private void clampToScreen() {
                  if (overlayView == null || overlayParams == null) return;
                  setPosition(overlayParams.x, overlayParams.y);
              }

              private void setPosition(int x, int y) {
                  if (overlayView == null || overlayParams == null) return;

                  int[] wh = getScreenSize();
                  int screenW = wh[0];
                  int screenH = wh[1];

                  float scale = sizePercent / 100.0f;
                  if (scale <= 0f) scale = 1f;
                  
                  int actualW = (int) Math.ceil(baseContentW * scale);
                  int actualH = (int) Math.ceil(baseContentH * scale);

                  if (actualW <= 0 || actualH <= 0) {
                      actualW = baseContentW;
                      actualH = baseContentH;
                  }

                  int minX = 0;
                  int minY = 0;
                  int maxX = Math.max(0, screenW - actualW);
                  int maxY = Math.max(0, screenH - actualH);

                  overlayParams.x = clamp(x, minX, maxX);
                  overlayParams.y = clamp(y, minY, maxY);

                  try { wm.updateViewLayout(overlayView, overlayParams); } catch (Exception ignored) {}
              }

              private int[] getScreenSize() {
                  try {
                      if (Build.VERSION.SDK_INT >= 30) {
                          WindowMetrics m = wm.getCurrentWindowMetrics();
                          Rect b = m.getBounds();
                          return new int[]{ b.width(), b.height() };
                      } else {
                          Display d = wm.getDefaultDisplay();
                          Point p = new Point();
                          d.getRealSize(p);
                          return new int[]{ p.x, p.y };
                      }
                  } catch (Exception e) {
                      return new int[]{ 1080, 1920 };
                  }
              }

              private void startTimer() {
                  cancelTimerAndPending();
                  isPaused = false;
                  updateToggleText();
                  timer = new CountDownTimer(totalSeconds * 1000, 1000) {
                      @Override public void onTick(long millisUntilFinished) {
                          totalSeconds = millisUntilFinished / 1000;
                          updateTimerText();
                      }
                      @Override public void onFinish() {
                          totalSeconds = 0;
                          updateTimerText();
                          showRedScreen();
                      }
                  }.start();
              }

              private void pauseTimer() {
                  if (isPaused) return;
                  isPaused = true;
                  try { if (timer != null) timer.cancel(); } catch (Exception ignored) {}
                  updateToggleText();
              }

              private void resumeTimer() {
                  if (!isPaused) return;
                  startTimer();
              }

              private void resetTimer() {
                  cancelTimerAndPending();
                  isPaused = true;
                  totalSeconds = initialSeconds;
                  updateTimerText();
                  updateToggleText();
              }

              private void nextQuestion() {
                  if (overlayView == null) return;
                  Button btnNext = overlayView.findViewById(R.id.btnNext);
                  btnNext.setEnabled(false);
                  handler.postDelayed(() -> {
                      cancelTimerAndPending();
                      totalSeconds = initialSeconds;
                      isPaused = false;
                      updateTimerText();
                      startTimer();
                      try { btnNext.setEnabled(true); } catch (Exception ignored) {}
                  }, 800);
              }

              private void showRedScreen() {
                  if (redScreenView != null) return;
                  playDing();
                  try {
                      int type = (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O)
                              ? WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY
                              : WindowManager.LayoutParams.TYPE_PHONE;

                      WindowManager.LayoutParams params = new WindowManager.LayoutParams(
                              WindowManager.LayoutParams.MATCH_PARENT,
                              WindowManager.LayoutParams.MATCH_PARENT,
                              type,
                              WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE
                                      | WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN
                                      | WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,
                              PixelFormat.TRANSLUCENT
                      );

                      redScreenView = LayoutInflater.from(this).inflate(R.layout.red_screen, null);
                      wm.addView(redScreenView, params);

                      Button btnSkip = redScreenView.findViewById(R.id.btnSkip);
                      btnSkip.setOnClickListener(v -> {
                          hideRedScreen();
                          cancelTimerAndPending();
                          pendingResume = () -> {
                              totalSeconds = initialSeconds;
                              isPaused = false;
                              startTimer();
                          };
                          handler.postDelayed(pendingResume, 2000);
                      });
                  } catch (Exception e) {
                      redScreenView = null;
                  }
              }

              private void playDing() {
                  try {
                      final ToneGenerator tg = new ToneGenerator(AudioManager.STREAM_NOTIFICATION, 100);
                      tg.startTone(ToneGenerator.TONE_PROP_BEEP, 140);
                      handler.postDelayed(() -> {
                          try { tg.startTone(ToneGenerator.TONE_PROP_BEEP, 140); } catch (Exception ignored) {}
                          handler.postDelayed(() -> {
                              try { tg.release(); } catch (Exception ignored) {}
                          }, 250);
                      }, 220);
                  } catch (Exception ignored) {}
              }

              private void hideRedScreen() {
                  if (redScreenView == null) return;
                  try { wm.removeView(redScreenView); } catch (Exception ignored) {}
                  redScreenView = null;
              }

              private void updateTimerText() {
                  if (overlayView == null) return;
                  try {
                      long m = totalSeconds / 60;
                      long s = totalSeconds % 60;
                      TextView tv = overlayView.findViewById(R.id.tvTimer);
                      tv.setText(String.format("%02d:%02d", m, s));
                  } catch (Exception ignored) {}
              }

              private void updateToggleText() {
                  if (overlayView == null) return;
                  try {
                      Button btnToggle = overlayView.findViewById(R.id.btnToggle);
                      btnToggle.setText(isPaused ? getString(R.string.btn_start) : getString(R.string.btn_pause));
                  } catch (Exception ignored) {}
              }

              private void cancelTimerAndPending() {
                  try { if (timer != null) timer.cancel(); } catch (Exception ignored) {}
                  timer = null;
                  try { if (pendingResume != null) handler.removeCallbacks(pendingResume); } catch (Exception ignored) {}
                  pendingResume = null;
              }

              private void stopCompletely() {
                  try { cancelTimerAndPending(); } catch (Exception ignored) {}
                  try {
                      if (overlayView != null) {
                          wm.removeView(overlayView);
                          overlayView = null;
                          overlayContent = null;
                      }
                  } catch (Exception ignored) {}
                  try {
                      if (redScreenView != null) {
                          wm.removeView(redScreenView);
                          redScreenView = null;
                      }
                  } catch (Exception ignored) {}
                  try { stopForeground(true); } catch (Exception ignored) {}
                  try { stopSelf(); } catch (Exception ignored) {}
              }

              private Notification buildNotification() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                      NotificationManager nm = getSystemService(NotificationManager.class);
                      NotificationChannel ch = new NotificationChannel(
                              CHANNEL_ID, "YKS Saya√ß", NotificationManager.IMPORTANCE_LOW
                      );
                      nm.createNotificationChannel(ch);
                      return new Notification.Builder(this, CHANNEL_ID)
                              .setContentTitle("YKS Saya√ß")
                              .setContentText("Saya√ß √ßalƒ±≈üƒ±yor")
                              .setSmallIcon(android.R.drawable.ic_dialog_info)
                              .build();
                  } else {
                      return new Notification.Builder(this)
                              .setContentTitle("YKS Saya√ß")
                              .setContentText("Saya√ß √ßalƒ±≈üƒ±yor")
                              .setSmallIcon(android.R.drawable.ic_dialog_info)
                              .build();
                  }
              }

              @Override
              public void onDestroy() {
                  super.onDestroy();
                  try { cancelTimerAndPending(); } catch (Exception ignored) {}
                  try { if (overlayView != null) wm.removeView(overlayView); } catch (Exception ignored) {}
                  overlayView = null;
                  overlayContent = null;
                  try { if (redScreenView != null) wm.removeView(redScreenView); } catch (Exception ignored) {}
                  redScreenView = null;
              }

              private static int clamp(int v, int lo, int hi) {
                  return v < lo ? lo : (v > hi ? hi : v);
              }
          }
          """)

          PY

      - name: Build Debug APK (installable)
        shell: bash
        run: |
          set -euo pipefail
          gradle :app:assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: YKS-Timer-APK
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error
