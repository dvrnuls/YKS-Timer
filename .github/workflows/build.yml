name: Build YKS Timer APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Create Android project
        run: |
          set -e

          mkdir -p app/src/main/java/com/yks/timer
          mkdir -p app/src/main/res/{layout,values,mipmap-mdpi,mipmap-hdpi,mipmap-xhdpi,mipmap-xxhdpi}
          mkdir -p gradle/wrapper

          cat > settings.gradle <<'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "YKS Timer"
          include(":app")
          EOF

          cat > build.gradle <<'EOF'
          plugins {
              id "com.android.application" version "8.1.2" apply false
              id "org.jetbrains.kotlin.android" version "1.9.10" apply false
          }
          EOF

          cat > gradle.properties <<'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          android.suppressUnsupportedCompileSdk=34
          EOF

          cat > app/build.gradle <<'EOF'
          plugins {
              id "com.android.application"
              id "org.jetbrains.kotlin.android"
          }

          android {
              namespace "com.yks.timer"
              compileSdk 34

              defaultConfig {
                  applicationId "com.yks.timer"
                  minSdk 23
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }

              kotlinOptions {
                  jvmTarget = "1.8"
              }

              buildFeatures {
                  viewBinding true
              }
          }

          dependencies {
              implementation "androidx.core:core-ktx:1.12.0"
              implementation "androidx.appcompat:appcompat:1.6.1"
              implementation "com.google.android.material:material:1.11.0"
              implementation "androidx.constraintlayout:constraintlayout:2.1.4"
          }
          EOF

          cat > app/src/main/AndroidManifest.xml <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>

              <application
                  android:label="YKS Sayaç"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher"
                  android:theme="@style/Theme.Material3.DayNight"
                  android:supportsRtl="true">

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>

                  <service
                      android:name=".TimerService"
                      android:exported="false"
                      android:foregroundServiceType="specialUse"/>
              </application>
          </manifest>
          EOF

          cat > app/src/main/java/com/yks/timer/MainActivity.kt <<'EOF'
          package com.yks.timer

          import android.content.Intent
          import android.net.Uri
          import android.os.Build
          import android.os.Bundle
          import android.provider.Settings
          import androidx.appcompat.app.AppCompatActivity
          import com.yks.timer.databinding.ActivityMainBinding

          class MainActivity : AppCompatActivity() {

              private lateinit var b: ActivityMainBinding

              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  b = ActivityMainBinding.inflate(layoutInflater)
                  setContentView(b.root)

                  b.startPause.setOnClickListener {
                      if (canDraw()) {
                          startService(Intent(this, TimerService::class.java))
                      } else {
                          requestOverlay()
                      }
                  }
              }

              private fun canDraw(): Boolean =
                  Build.VERSION.SDK_INT < 23 || Settings.canDrawOverlays(this)

              private fun requestOverlay() {
                  val i = Intent(
                      Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                      Uri.parse("package:$packageName")
                  )
                  startActivity(i)
              }
          }
          EOF

          cat > app/src/main/java/com/yks/timer/TimerService.kt <<'EOF'
          package com.yks.timer

          import android.app.*
          import android.content.Context
          import android.content.Intent
          import android.graphics.PixelFormat
          import android.media.ToneGenerator
          import android.media.AudioManager
          import android.os.*
          import android.util.DisplayMetrics
          import android.view.*
          import android.widget.Button
          import android.widget.TextView
          import androidx.core.app.NotificationCompat
          import kotlin.math.max
          import kotlin.math.min

          class TimerService : Service() {

              private lateinit var wm: WindowManager
              private lateinit var view: View
              private lateinit var params: WindowManager.LayoutParams

              private var total = 60L
              private var timer: CountDownTimer? = null
              private var paused = true

              private var lastX = 0
              private var lastY = 0
              private var startX = 0
              private var startY = 0

              override fun onBind(intent: Intent?) = null

              override fun onCreate() {
                  super.onCreate()
                  createChannel()
                  startForeground(1, notif())
                  wm = getSystemService(Context.WINDOW_SERVICE) as WindowManager
                  showOverlay()
              }

              private fun showOverlay() {
                  val metrics = DisplayMetrics()
                  wm.defaultDisplay.getMetrics(metrics)

                  params = WindowManager.LayoutParams(
                      WindowManager.LayoutParams.WRAP_CONTENT,
                      WindowManager.LayoutParams.WRAP_CONTENT,
                      if (Build.VERSION.SDK_INT >= 26)
                          WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY
                      else WindowManager.LayoutParams.TYPE_PHONE,
                      WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
                      PixelFormat.TRANSLUCENT
                  )

                  view = LayoutInflater.from(this).inflate(R.layout.overlay_timer, null)

                  view.setOnTouchListener { _, e ->
                      when (e.action) {
                          MotionEvent.ACTION_DOWN -> {
                              lastX = params.x
                              lastY = params.y
                              startX = e.rawX.toInt()
                              startY = e.rawY.toInt()
                              true
                          }
                          MotionEvent.ACTION_MOVE -> {
                              val dx = e.rawX.toInt() - startX
                              val dy = e.rawY.toInt() - startY

                              params.x = min(
                                  max(lastX + dx, 0),
                                  metrics.widthPixels - view.width
                              )
                              params.y = min(
                                  max(lastY + dy, 0),
                                  metrics.heightPixels - view.height
                              )
                              wm.updateViewLayout(view, params)
                              true
                          }
                          else -> false
                      }
                  }

                  val btn = view.findViewById<Button>(R.id.toggle)
                  val tv = view.findViewById<TextView>(R.id.time)

                  btn.setOnClickListener {
                      if (paused) start(tv, btn) else pause(btn)
                  }

                  wm.addView(view, params)
              }

              private fun start(tv: TextView, btn: Button) {
                  paused = false
                  btn.text = "⏸"
                  timer = object : CountDownTimer(total * 1000, 1000) {
                      override fun onTick(ms: Long) {
                          total = ms / 1000
                          tv.text = "%02d:%02d".format(total / 60, total % 60)
                      }
                      override fun onFinish() {
                          ToneGenerator(AudioManager.STREAM_ALARM, 100).startTone(ToneGenerator.TONE_PROP_BEEP, 150)
                          ToneGenerator(AudioManager.STREAM_ALARM, 100).startTone(ToneGenerator.TONE_PROP_BEEP, 150)
                          Handler(Looper.getMainLooper()).postDelayed({
                              total = 60
                              start(tv, btn)
                          }, 2000)
                      }
                  }.start()
              }

              private fun pause(btn: Button) {
                  paused = true
                  btn.text = "▶"
                  timer?.cancel()
              }

              private fun createChannel() {
                  if (Build.VERSION.SDK_INT >= 26) {
                      val c = NotificationChannel("c","Timer",NotificationManager.IMPORTANCE_LOW)
                      getSystemService(NotificationManager::class.java).createNotificationChannel(c)
                  }
              }

              private fun notif() =
                  NotificationCompat.Builder(this, "c")
                      .setContentTitle("YKS Sayaç")
                      .setSmallIcon(android.R.drawable.ic_lock_idle_alarm)
                      .build()
          }
          EOF

          cat > app/src/main/res/layout/overlay_timer.xml <<'EOF'
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:orientation="vertical"
              android:padding="12dp"
              android:background="@android:color/white">

              <TextView
                  android:id="@+id/time"
                  android:text="01:00"
                  android:textSize="24sp"
                  android:textStyle="bold"/>

              <Button
                  android:id="@+id/toggle"
                  android:text="▶"/>
          </LinearLayout>
          EOF

          cat > app/src/main/res/layout/activity_main.xml <<'EOF'
          <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent">

              <Button
                  android:id="@+id/startPause"
                  android:layout_width="wrap_content"
                  android:layout_height="wrap_content"
                  android:text="Başlat"/>
          </FrameLayout>
          EOF

          # valid PNG icon (1x1)
          echo iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg== | base64 -d > app/src/main/res/mipmap-mdpi/ic_launcher.png
          cp app/src/main/res/mipmap-mdpi/ic_launcher.png app/src/main/res/mipmap-hdpi/ic_launcher.png
          cp app/src/main/res/mipmap-mdpi/ic_launcher.png app/src/main/res/mipmap-xhdpi/ic_launcher.png
          cp app/src/main/res/mipmap-mdpi/ic_launcher.png app/src/main/res/mipmap-xxhdpi/ic_launcher.png

          cat > gradle/wrapper/gradle-wrapper.properties <<'EOF'
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
          EOF

          curl -L https://raw.githubusercontent.com/gradle/gradle/v8.2.0/gradle/wrapper/gradle-wrapper.jar -o gradle/wrapper/gradle-wrapper.jar

          cat > gradlew <<'EOF'
          #!/bin/sh
          exec java -jar "$(dirname "$0")/gradle/wrapper/gradle-wrapper.jar" "$@"
          EOF
          chmod +x gradlew

      - name: Build APK
        run: ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: YKS-Timer-APK
          path: app/build/outputs/apk/debug/*.apk
