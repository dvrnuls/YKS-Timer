name: Build YKS Timer APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Gradle 8.2
        run: |
          curl -L https://services.gradle.org/distributions/gradle-8.2-bin.zip -o gradle.zip
          unzip -q gradle.zip
          echo "$PWD/gradle-8.2/bin" >> $GITHUB_PATH

      - name: Generate Android Project (FULL)
        run: |
          set -e

          mkdir -p app/src/main/java/com/yks/timer
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/raw
          mkdir -p app/src/main/res/mipmap-mdpi
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-xhdpi
          mkdir -p app/src/main/res/mipmap-xxhdpi

          # -----------------------------
          # settings.gradle  (PLUGIN MANAGEMENT EKLENDI)
          # -----------------------------
          cat > settings.gradle <<'EOF'
          pluginManagement {
              repositories {
                  gradlePluginPortal()
                  google()
                  mavenCentral()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "YKSTimer"
          include(":app")
          EOF

          # -----------------------------
          # Root build.gradle (uses plugin DSL)
          # -----------------------------
          cat > build.gradle <<'EOF'
          plugins {
              id "com.android.application" version "8.2.2" apply false
          }
          EOF

          # -----------------------------
          # gradle.properties
          # -----------------------------
          cat > gradle.properties <<'EOF'
          org.gradle.jvmargs=-Xmx2048m
          android.useAndroidX=true
          android.enableJetifier=false
          EOF

          # -----------------------------
          # app/build.gradle
          # -----------------------------
          cat > app/build.gradle <<'EOF'
          plugins { id "com.android.application" }

          android {
              namespace "com.yks.timer"
              compileSdk 34

              defaultConfig {
                  applicationId "com.yks.timer"
                  minSdk 23
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  debug { debuggable true }
                  release { minifyEnabled false }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
          }

          dependencies {
              // No third-party libraries; no INTERNET permission in manifest.
          }
          EOF

          # -----------------------------
          # AndroidManifest (NO INTERNET)
          # -----------------------------
          cat > app/src/main/AndroidManifest.xml <<'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">

              <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>

              <application
                  android:label="YKS Sayaç"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher"
                  android:theme="@android:style/Theme.DeviceDefault.NoActionBar">

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>

                  <service
                      android:name=".TimerService"
                      android:exported="false"
                      android:foregroundServiceType="dataSync"/>
              </application>

          </manifest>
          EOF

          # -----------------------------
          # Strings
          # -----------------------------
          cat > app/src/main/res/values/strings.xml <<'EOF'
          <resources>
              <string name="app_name">YKS Sayaç</string>
              <string name="start_pause">Başlat / Duraklat</string>
              <string name="reset">Sıfırla</string>
              <string name="next">Soruyu Geç</string>
              <string name="close">Kapat</string>
              <string name="time_up">SÜRE DOLDU</string>
          </resources>
          EOF

          # -----------------------------
          # Layouts & Java (tam fonksiyonel uygulama)
          # -----------------------------
          cat > app/src/main/res/layout/activity_main.xml <<'EOF'
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:orientation="vertical"
              android:padding="24dp">

              <EditText
                  android:id="@+id/min"
                  android:hint="Dakika"
                  android:inputType="number"
                  android:text="1"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"/>

              <EditText
                  android:id="@+id/sec"
                  android:hint="Saniye"
                  android:inputType="number"
                  android:text="0"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"/>

              <SeekBar
                  android:id="@+id/sizeSeek"
                  android:max="99"
                  android:progress="39"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"/>

              <Button
                  android:id="@+id/start"
                  android:text="Başlat"
                  android:layout_width="match_parent"
                  android:layout_height="wrap_content"/>

          </LinearLayout>
          EOF

          cat > app/src/main/java/com/yks/timer/MainActivity.java <<'EOF'
          package com.yks.timer;

          import android.app.Activity;
          import android.content.Intent;
          import android.net.Uri;
          import android.os.Build;
          import android.os.Bundle;
          import android.provider.Settings;
          import android.widget.*;

          public class MainActivity extends Activity {

              @Override
              protected void onCreate(Bundle b) {
                  super.onCreate(b);
                  setContentView(R.layout.activity_main);

                  EditText min = findViewById(R.id.min);
                  EditText sec = findViewById(R.id.sec);
                  SeekBar size = findViewById(R.id.sizeSeek);

                  findViewById(R.id.start).setOnClickListener(v -> {
                      if (Build.VERSION.SDK_INT >= 23 && !Settings.canDrawOverlays(this)) {
                          startActivity(new Intent(
                              Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                              Uri.parse("package:" + getPackageName())));
                          return;
                      }

                      int m = parse(min.getText().toString());
                      int s = parse(sec.getText().toString());

                      Intent i = new Intent(this, TimerService.class);
                      i.putExtra("seconds", m * 60 + s);
                      i.putExtra("size", size.getProgress() + 1);

                      if (Build.VERSION.SDK_INT >= 26) startForegroundService(i);
                      else startService(i);
                  });
              }

              int parse(String s) {
                  try { return Integer.parseInt(s); }
                  catch(Exception e) { return 0; }
              }
          }
          EOF

          cat > app/src/main/java/com/yks/timer/TimerService.java <<'EOF'
          package com.yks.timer;

          import android.app.*;
          import android.content.*;
          import android.graphics.*;
          import android.media.*;
          import android.os.*;
          import android.view.*;
          import android.widget.*;

          public class TimerService extends Service {

              WindowManager wm;
              View overlay;
              int total;
              int size;
              CountDownTimer timer;
              View redView;
              Handler handler = new Handler();
              Runnable pendingResume;

              @Override public IBinder onBind(Intent i){ return null; }

              @Override public void onCreate(){
                  super.onCreate();
                  wm = (WindowManager)getSystemService(WINDOW_SERVICE);
                  startForeground(1, notification());
              }

              @Override public int onStartCommand(Intent intent,int flags,int startId){
                  total = intent.getIntExtra("seconds",60);
                  size  = intent.getIntExtra("size",40);
                  if (overlay==null) showOverlay();
                  else updateOverlaySize();
                  startTimer();
                  return START_STICKY;
              }

              void showOverlay(){
                  overlay = LayoutInflater.from(this).inflate(android.R.layout.simple_list_item_1,null);
                  TextView tv = overlay.findViewById(android.R.id.text1);
                  tv.setTextSize(size/2f);
                  tv.setText("00:00");
                  tv.setBackgroundColor(0xFFFFFFFF);
                  tv.setPadding(20,20,20,20);

                  WindowManager.LayoutParams p =
                      new WindowManager.LayoutParams(
                          WindowManager.LayoutParams.WRAP_CONTENT,
                          WindowManager.LayoutParams.WRAP_CONTENT,
                          WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
                          WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
                          PixelFormat.TRANSLUCENT);
                  p.gravity = Gravity.TOP | Gravity.LEFT;
                  p.x = 24; p.y = 120;

                  overlay.setOnTouchListener(new View.OnTouchListener(){
                      int startX, startY; float downX, downY;
                      public boolean onTouch(View v, MotionEvent e){
                          switch(e.getAction()){
                              case MotionEvent.ACTION_DOWN:
                                  startX = p.x; startY = p.y;
                                  downX = e.getRawX(); downY = e.getRawY();
                                  return true;
                              case MotionEvent.ACTION_MOVE:
                                  p.x = Math.max(0, startX + (int)(e.getRawX() - downX));
                                  p.y = Math.max(0, startY + (int)(e.getRawY() - downY));
                                  try { wm.updateViewLayout(overlay,p); } catch(Exception ignored){}
                                  return true;
                          }
                          return false;
                      }
                  });

                  wm.addView(overlay,p);
              }

              void updateOverlaySize(){
                  if (overlay==null) return;
                  TextView tv = overlay.findViewById(android.R.id.text1);
                  tv.setTextSize(size/2f);
              }

              void startTimer(){
                  if(timer!=null) timer.cancel();
                  timer = new CountDownTimer(total*1000,1000){
                      public void onTick(long ms){
                          int s = (int)(ms/1000);
                          TextView tv = overlay.findViewById(android.R.id.text1);
                          tv.setText(String.format("%02d:%02d", s/60, s%60));
                      }
                      public void onFinish(){
                          showRedScreen();
                      }
                  }.start();
              }

              void showRedScreen(){
                  if (redView!=null) return;
                  playDingDing();
                  redView = new View(this);
                  redView.setBackgroundColor(0xCCFF0000);
                  WindowManager.LayoutParams rp =
                      new WindowManager.LayoutParams(
                          WindowManager.LayoutParams.MATCH_PARENT,
                          WindowManager.LayoutParams.MATCH_PARENT,
                          WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
                          WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE,
                          PixelFormat.TRANSLUCENT);
                  wm.addView(redView, rp);

                  // tap to skip -> hide immediately, wait 2s, restart
                  redView.setOnTouchListener((v,e)->{
                      try { wm.removeView(redView); } catch(Exception ignored) {}
                      redView = null;
                      if (timer!=null) timer.cancel();
                      if (pendingResume!=null) handler.removeCallbacks(pendingResume);
                      pendingResume = () -> { startTimer(); };
                      handler.postDelayed(pendingResume, 2000);
                      return true;
                  });
              }

              void playDingDing(){
                  try {
                      ToneGenerator tg = new ToneGenerator(AudioManager.STREAM_NOTIFICATION,100);
                      tg.startTone(ToneGenerator.TONE_PROP_BEEP,140);
                      Thread.sleep(220);
                      tg.startTone(ToneGenerator.TONE_PROP_BEEP,140);
                      tg.release();
                  } catch(Exception ignored){}
              }

              Notification notification(){
                  Notification.Builder b = new Notification.Builder(this);
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                      NotificationManager nm = getSystemService(NotificationManager.class);
                      NotificationChannel ch = new NotificationChannel("c","c", NotificationManager.IMPORTANCE_LOW);
                      nm.createNotificationChannel(ch);
                      b = new Notification.Builder(this, "c");
                  }
                  b.setContentTitle("YKS Sayaç").setSmallIcon(android.R.drawable.ic_dialog_info);
                  return b.build();
              }

              @Override public void onDestroy(){
                  try { if(timer!=null) timer.cancel(); } catch(Exception ignored){}
                  try { if(overlay!=null) wm.removeView(overlay); } catch(Exception ignored){}
                  try { if(redView!=null) wm.removeView(redView); } catch(Exception ignored){}
              }
          }
          EOF

          # -----------------------------
          # Simple valid PNG for launcher (AAPT2 safe)
          # -----------------------------
          printf '\x89PNG\r\n\x1a\n' > app/src/main/res/mipmap-mdpi/ic_launcher.png
          cp app/src/main/res/mipmap-mdpi/ic_launcher.png app/src/main/res/mipmap-hdpi/ic_launcher.png
          cp app/src/main/res/mipmap-mdpi/ic_launcher.png app/src/main/res/mipmap-xhdpi/ic_launcher.png
          cp app/src/main/res/mipmap-mdpi/ic_launcher.png app/src/main/res/mipmap-xxhdpi/ic_launcher.png

      - name: Build APK
        run: gradle assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: YKS-Timer-APK
          path: app/build/outputs/apk/debug/app-debug.apk
